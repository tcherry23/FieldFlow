<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Pressure</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f7f9fc; margin:0; }
    header { background:#004080; color:#fff; padding:14px 16px; }
    header h1 { margin:0; font-size:1.2rem; }
    .wrap { max-width:900px; margin:20px auto; background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.08); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    label { font-weight:600; font-size:.9rem; color:#233; display:block; margin-bottom:6px; }
    input[type="number"], input[type="date"], input[type="text"], select, textarea {
      width:100%; padding:10px; border:1px solid #cfd7e3; border-radius:8px; box-sizing:border-box; background:#fff;
    }
    textarea { min-height:80px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .btn { background:#004080; color:#fff; border:0; border-radius:8px; padding:10px 14px; cursor:pointer; }
    .btn.secondary { background:#e9edf7; color:#123; }
    .hint { font-size:.85rem; color:#667; margin-top:6px; }
  </style>
</head>
<body>
  <header><h1>Daily Pressure</h1></header>

  <div class="wrap">
    <div class="grid">
      <div>
        <label for="field">Field</label>
        <select id="field">
          <option value="">Select Field</option>
          <option value="Dixon">Dixon</option>
          <option value="Mineral City">Mineral City</option>
          <option value="Simpson Chapel">Simpson Chapel</option>
        </select>
      </div>

      <div>
        <label for="well">Well</label>
        <select id="well" disabled>
          <option value="">Select Well</option>
        </select>
        <div class="hint" id="wellMeta"></div>
      </div>

      <div>
        <label for="attendant">Attendant</label>
        <select id="attendant">
          <option value="T. Cherry">T. Cherry</option>
          <option value="T. Ressler">T. Ressler</option>
        </select>
      </div>

      <div>
        <label for="date">Date</label>
        <input id="date" type="date"/>
      </div>

      <div>
        <label for="upstream">Upstream (PSI)</label>
        <input id="upstream" type="number" step="0.01" inputmode="decimal" />
      </div>

      <div>
        <label for="downstream">Downstream (PSI)</label>
        <input id="downstream" type="number" step="0.01" inputmode="decimal" />
      </div>

      <div>
        <label for="differential">Differential (PSI)</label>
        <input id="differential" type="number" step="0.01" inputmode="decimal" />
        <div class="hint">Auto-calculates = Upstream − Downstream (editable)</div>
      </div>

      <div>
        <label for="dpH2O">ΔP (in H₂O)</label>
        <input id="dpH2O" type="number" step="0.01" inputmode="decimal" />
      </div>

      <div>
        <label for="orifice">Orifice (in)</label>
        <input id="orifice" type="number" step="0.0001" inputmode="decimal" />
        <div class="hint">Auto-fills from master list; editable</div>
      </div>

      <div>
        <label for="mcfhr">MCF / hr</label>
        <input id="mcfhr" type="number" step="0.01" inputmode="decimal" />
      </div>
    </div>

    <div style="margin-top:12px;">
      <label for="notes">Notes</label>
      <textarea id="notes" placeholder="Optional notes..."></textarea>
    </div>

    <div class="row">
      <button class="btn" type="button" id="saveDaily">Save</button>
      <button class="btn secondary" type="button" onclick="location.href='index.html'">Home</button>
    </div>
  </div>

  <!-- Shared backend -->
  <script src="app.js" defer></script>
  <script>
    // Wait a tick to ensure app.js loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Set today's date
      const dateEl = document.getElementById('date');
      dateEl.value = new Date().toISOString().slice(0,10);

      const fieldEl = document.getElementById('field');
      const wellEl  = document.getElementById('well');
      const metaEl  = document.getElementById('wellMeta');

      function populateWells() {
        const field = fieldEl.value;
        wellEl.innerHTML = '<option value="">Select Well</option>';
        wellEl.disabled = !field;
        metaEl.textContent = '';
        if (!field) return;

        // Ensure registry ready, then fill
        if (window.FieldFlow && FieldFlow.wellsForField) {
          const wells = FieldFlow.wellsForField(field);
          wells.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w; opt.textContent = w;
            wellEl.appendChild(opt);
          });
        }
      }

      fieldEl.addEventListener('change', () => {
        populateWells();
      });

      wellEl.addEventListener('change', () => {
        const field = fieldEl.value;
        const well  = wellEl.value;
        if (!field || !well || !window.FieldFlow) return;
        const id   = FieldFlow.resolveWellId(field, well);
        const ori  = FieldFlow.resolveOrifice(field, well);
        document.getElementById('orifice').value = ori ? Number(ori).toFixed(4) : '';
        metaEl.textContent = id ? `Well # ${id}` : '';
      });

      // Differential auto-calc on change of upstream/downstream
      function recalcDiff() {
        const up = parseFloat(document.getElementById('upstream').value || '0');
        const dn = parseFloat(document.getElementById('downstream').value || '0');
        if (!isNaN(up) && !isNaN(dn)) {
          document.getElementById('differential').value = (up - dn).toFixed(2);
        }
      }
      document.getElementById('upstream').addEventListener('input', recalcDiff);
      document.getElementById('downstream').addEventListener('input', recalcDiff);

      // Save handler
      document.getElementById('saveDaily').addEventListener('click', function () {
        const get = id => document.getElementById(id);
        const num = v => (v === '' || v == null) ? 0 : Number(v);

        const payload = {
          field:      get('field').value || '',
          well:       get('well').value || '',
          attendant:  get('attendant').value || '',
          date:       get('date').value || new Date().toISOString().slice(0,10),
          upstream:   num(get('upstream').value),
          downstream: num(get('downstream').value),
          differential: num(get('differential').value),
          dpH2O:      num(get('dpH2O').value),
          orifice:    num(get('orifice').value),
          mcfhr:      num(get('mcfhr').value),
          notes:      get('notes').value || ''
        };

        if (!payload.field) { alert('Select a Field.'); return; }
        if (!payload.well)  { alert('Select a Well.'); return; }

        if (!window.FieldFlow || !FieldFlow.saveDailyPressure) {
          alert('Backend not loaded. Make sure app.js is included.'); return;
        }

        FieldFlow.saveDailyPressure(payload);
        alert('Daily pressure saved.');

        // Optional: clear numeric inputs after save
        ['upstream','downstream','differential','dpH2O','mcfhr','notes'].forEach(id=>{
          const el = get(id); if (el) el.value = '';
        });
        // keep date, field, well, attendant for faster next entry
      });

      // If app.js is still loading registry, populate after init
      if (window.FieldFlow && FieldFlow.init) {
        FieldFlow.init().then(() => {
          // If user already picked field before init finished
          if (fieldEl.value) populateWells();
        });
      }
    });
  </script>
</body>
</html>
