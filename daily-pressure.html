<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>FieldFlow – Daily Pressure</title>
<style>
  :root{--ink:#e5e7eb;--muted:#9ca3af;--pri:#0B5FFF}
  html,body{margin:0;background:#0b1220;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:linear-gradient(90deg,#0B5FFF22,#12B88622)}
  h1{font-size:18px;margin:0}
  .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:10px;padding:12px 14px;margin-bottom:14px}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .grid .full{grid-column:1/-1}
  label{font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:6px}
  input,select{background:#0b1220;border:1px solid #1f2937;color:var(--ink);border-radius:8px;padding:10px 12px;font-size:14px;outline:none}
  input:focus,select:focus{border-color:var(--pri)}
  .calc{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:8px;margin-top:10px}
  .calc>div{background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:10px 12px}
  .calc b{display:block;color:#9ca3af;font-size:12px;margin-bottom:4px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{background:#0B5FFF;border:none;color:white;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.secondary{background:#0b1220;border:1px solid #1f2937}
  button.warn{background:#b91c1c}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1f2937;padding:10px 8px;font-size:13px;text-align:left}
  th{color:#9fb2ff}
  tr.flag-yellow{background:#2f2a12} tr.flag-red{background:#331b1b}
  .files-list{display:flex;flex-direction:column;gap:8px}
  .file-row{display:flex;justify-content:space-between;align-items:center;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:8px 10px}
  .file-row small{color:#9ca3af}
  .goal{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:10px}
  .goal>div{background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:10px 12px}
  .goal b{display:block;color:#9ca3af;font-size:12px;margin-bottom:4px}
  .goal input{width:100%}
</style>
</head>
<body>
<header><h1>FieldFlow – Daily Pressure</h1><span id="status" style="opacity:.75">Ready</span></header>

<div class="wrap">
  <div class="card">
    <div class="grid">
      <label>Attendant
        <select id="attendant"><option value="T. Cherry">T. Cherry</option><option>Operator A</option><option>Operator B</option></select>
      </label>
      <label>Date <input type="date" id="date"></label>
      <label>Time <input type="time" id="time"></label>

      <label>Field <select id="field"></select></label>
      <label>Well <select id="well"></select></label>
      <label>IGS ID (auto) <input id="igs" type="text" readonly></label>
      <label>Orifice (in) (auto; editable) <input id="orifice" type="number" step="0.0001" inputmode="decimal"></label>
      <label>Line Group (optional) <input id="line" type="text" placeholder="e.g., Crays Segment"></label>

      <label>Upstream PSI <input id="up" type="number" step="0.1" inputmode="decimal"></label>
      <label>Downstream PSI <input id="dn" type="number" step="0.1" inputmode="decimal"></label>
      <label>Mode
        <select id="mode"><option>Withdrawal</option><option>Injection</option><option>Idle</option><option>Shut-In</option></select>
      </label>
      <label class="full">Notes <input id="notes" type="text" placeholder="Optional remarks"></label>
    </div>

    <!-- Daily Field Target panel -->
    <div class="goal">
      <div><b>Target MCF/hr (Field)</b>
        <input id="fieldTarget" type="number" step="0.001" inputmode="decimal" placeholder="Enter target for this field">
      </div>
      <div><b>Current MCF/hr (Field)</b><span id="fieldCurrent">—</span></div>
      <div><b>Remaining to Target</b><span id="fieldRemain">—</span></div>
    </div>

    <div class="calc">
      <div><b>Orifice²</b><span id="or2">—</span></div>
      <div><b>ΔP (psi)</b><span id="dp">—</span></div>
      <div><b>ΔP (H₂O)</b><span id="dph2o">—</span></div>
      <div><b>MCF/hr</b><span id="mcf">—</span></div>
      <div><b>Flag</b><span id="flag">—</span></div>
    </div>

    <div class="actions">
      <button id="add">Add Row</button>
      <button class="secondary" id="export">Export CSV (all rows)</button>
      <button class="secondary" id="saveField">Save Field → Files</button>
      <button class="secondary" id="saveBundle">Save Bundle (All Rows)</button>
      <button class="secondary" id="exportAllFiles">Download All Files</button>
      <button class="warn" id="resetDay">Reset Day (clear rows)</button>
      <label class="secondary" style="padding:8px 12px;border-radius:8px;cursor:pointer">
        Import CSV<input type="file" id="import" accept=".csv" style="display:none">
      </label>
    </div>
  </div>

  <div class="card">
    <table>
      <thead>
      <tr>
        <th>Date</th><th>Time</th><th>Attendant</th><th>Field</th><th>Well</th><th>IGS_ID</th>
        <th>Orifice (in)</th><th>Up</th><th>Down</th><th>ΔP psi</th><th>ΔP H₂O</th><th>MCF/hr</th><th>Mode</th><th>Line</th><th>Notes</th>
      </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Files</h3>
    <div id="files" class="files-list"></div>
  </div>
</div>

<script>
/* ================= WELLS (Production only) =================
   ORDER matches your Annuals sheets.
*/
const WELLS = [
  // --------- DIXON (Evans first, then Corys) ---------
  { field:"Dixon", name:"Evans 7",  number:"118537", orifice:1.0000, order:101 },
  { field:"Dixon", name:"Evans 8",  number:"118538", orifice:1.0000, order:102 },
  { field:"Dixon", name:"Evans 3",  number:"118508", orifice:1.0000, order:103 },
  { field:"Dixon", name:"Evans 10", number:"118507", orifice:1.0000, order:104 },
  { field:"Dixon", name:"Evans 5",  number:"118536", orifice:1.2500, order:105 },
  { field:"Dixon", name:"Evans 4-H",number:"118540", orifice:1.0000, order:106 },
  { field:"Dixon", name:"Evans 6",  number:"118541", orifice:1.0000, order:107 },
  { field:"Dixon", name:"Cory 8",   number:"118527", orifice:1.0000, order:108 },
  { field:"Dixon", name:"Cory 4",   number:"118526", orifice:1.0000, order:109 },
  { field:"Dixon", name:"Cory 2",   number:"118571", orifice:1.0000, order:110 },
  { field:"Dixon", name:"Cory 7",   number:"118574", orifice:1.0000, order:111 },
  { field:"Dixon", name:"Cory 3",   number:"118572", orifice:1.0000, order:112 },
  { field:"Dixon", name:"Cory 6",   number:"118573", orifice:1.0000, order:113 },
  { field:"Dixon", name:"Cory 5",   number:"118506", orifice:1.0000, order:114 },
  { field:"Dixon", name:"Cory 1",   number:"118505", orifice:1.0000, order:115 },

  // --------- MINERAL CITY (your photo order) ---------
  { field:"Mineral City", name:"Rollison 4", number:"118002", orifice:0.7500, order:201 },
  { field:"Mineral City", name:"Rollison 1", number:"118016", orifice:0.7500, order:202 },
  { field:"Mineral City", name:"Rollison 2", number:"118017", orifice:0.7500, order:203 },
  { field:"Mineral City", name:"G. Axe 6",   number:"118005", orifice:1.0000, order:204 },
  { field:"Mineral City", name:"Haines 4",   number:"117997", orifice:0.3750, order:205 },
  { field:"Mineral City", name:"Haines 1",   number:"117994", orifice:1.0000, order:206 },
  { field:"Mineral City", name:"Haines 2",   number:"117995", orifice:1.0000, order:207 },
  { field:"Mineral City", name:"Haines 3",   number:"117996", orifice:1.0000, order:208 },
  { field:"Mineral City", name:"G. Axe 1",   number:"118004", orifice:1.0000, order:209 },
  { field:"Mineral City", name:"WS Allen 1", number:"117981", orifice:1.0000, order:210 },
  { field:"Mineral City", name:"G. Axe 2",   number:"118088", orifice:0.7500, order:211 },
  { field:"Mineral City", name:"G. Axe 4",   number:"118090", orifice:0.7500, order:212 },
  { field:"Mineral City", name:"G. Axe 5",   number:"118091", orifice:1.0000, order:213 },
  { field:"Mineral City", name:"G. Axe 3",   number:"118089", orifice:0.5000, order:214 },
  { field:"Mineral City", name:"J. Axe 1",   number:"118093", orifice:1.0000, order:215 },

  // --------- SIMPSON CHAPEL (sheet order) ---------
  { field:"Simpson Chapel", name:"Blaker 1", number:"118023", orifice:0.5000, order:301 },
  { field:"Simpson Chapel", name:"Emery 2",  number:"118027", orifice:0.7500, order:302 },
  { field:"Simpson Chapel", name:"Emery 1",  number:"118028", orifice:0.7500, order:303 },
  { field:"Simpson Chapel", name:"Crays 8",  number:"118025", orifice:1.0000, order:304 },
  { field:"Simpson Chapel", name:"Crays 1",  number:"118024",       orifice:0.5000, order:305 },  /* add IGS when ready */
  { field:"Simpson Chapel", name:"Crays 5",  number:"118136", orifice:0.7500, order:306 },
  { field:"Simpson Chapel", name:"Crays 4",  number:"118135", orifice:0.2500, order:307 },
  { field:"Simpson Chapel", name:"Crays 3",  number:"118134", orifice:0.7500, order:308 },
  { field:"Simpson Chapel", name:"Crays 7",  number:"118138", orifice:1.0000, order:309 },
  { field:"Simpson Chapel", name:"Crays 2",  number:"118133",       orifice:1.0000, order:310 },  /* add IGS when ready */
  { field:"Simpson Chapel", name:"Crays 6",  number:"118137", orifice:1.0000, order:311 },
  { field:"Simpson Chapel", name:"Royal 6",  number:"118143", orifice:0.6250, order:312 },
  { field:"Simpson Chapel", name:"Royal 5",  number:"118142", orifice:0.5000, order:313 },
  { field:"Simpson Chapel", name:"Royal 4",  number:"118030", orifice:0.5000, order:314 },
  { field:"Simpson Chapel", name:"Royal 7",  number:"118031", orifice:1.0000, order:315 },
  { field:"Simpson Chapel", name:"Royal 1",  number:"118029", orifice:0.5000, order:316 }
];

const AUTOSAVE_KEY='ff_daily_autosave_v1';
const FILES_KEY='ff_files';
const TARGETS_KEY='ff_targets_v1'; // stores per (date + field) target MCF/hr

const FIELDS=[...new Set(WELLS.map(w=>w.field))];
const state={rows:[]};
const $=id=>document.getElementById(id);
const dateEl=$('date'),timeEl=$('time'),attendantEl=$('attendant'),fieldSel=$('field'),wellSel=$('well'),
igsEl=$('igs'),orificeEl=$('orifice'),lineEl=$('line'),upEl=$('up'),dnEl=$('dn'),modeEl=$('mode'),notesEl=$('notes'),
or2El=$('or2'),dpEl=$('dp'),dph2oEl=$('dph2o'),mcfEl=$('mcf'),flagEl=$('flag'),rowsTbody=$('rows'),status=$('status'),
filesBox=$('files'), fieldTargetEl=$('fieldTarget'), fieldCurrentEl=$('fieldCurrent'), fieldRemainEl=$('fieldRemain');

// init
FIELDS.forEach(f=>{const o=document.createElement('option');o.value=f;o.textContent=f;fieldSel.appendChild(o);});
(function initDT(){
  const n=new Date();
  dateEl.value=n.toISOString().slice(0,10);
  timeEl.value=String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0');
  loadFiles(); loadState(); loadTargets(); refreshWells(); recalc(); updateFieldTotals();
})();

fieldSel.addEventListener('change', ()=>{refreshWells(); recalc(); loadTargetForCurrent(); updateFieldTotals(); afterChange();});
wellSel.addEventListener('change', ()=>{syncWellMeta(); recalc(); updateFieldTotals(); afterChange();});
[orificeEl,upEl,dnEl,notesEl,lineEl,dateEl,timeEl,attendantEl,modeEl].forEach(x=>x.addEventListener('input', ()=>{recalc(); updateFieldTotals(); afterChange();}));
fieldTargetEl.addEventListener('input', ()=>{saveTargetForCurrent(); updateFieldTotals();});

// buttons
$('add').addEventListener('click', ()=>{addRow(); updateFieldTotals();});
$('export').addEventListener('click', ()=>exportCSV(state.rows, `Daily_Pressure_${today()}.csv`));
$('import').addEventListener('change', importCSV);
$('saveField').addEventListener('click', saveCurrentFieldToFiles);
$('saveBundle').addEventListener('click', saveBundleToFiles);
$('exportAllFiles').addEventListener('click', downloadAllFiles);
$('resetDay').addEventListener('click', resetDay);
window.addEventListener('beforeunload', (e)=>{
  if (state.rows && state.rows.length){ saveState(); e.preventDefault(); e.returnValue=''; }
});

/* --------- Wells / calc ---------- */
function wellsForField(f){return WELLS.filter(w=>w.field===f).sort((a,b)=>(a.order??9999)-(b.order??9999));}
function refreshWells(){
  wellSel.innerHTML='';
  wellsForField(fieldSel.value).forEach(w=>{
    const opt=document.createElement('option');
    opt.value=w.number; opt.textContent=w.name; opt.dataset.name=w.name; opt.dataset.orifice=w.orifice;
    wellSel.appendChild(opt);
  });
  syncWellMeta();
}
function syncWellMeta(){
  const opt=wellSel.options[wellSel.selectedIndex]; if(!opt){igsEl.value='';orificeEl.value='';return;}
  igsEl.value=opt.value; orificeEl.value=Number(opt.dataset.orifice||0).toFixed(4);
}
function blankCalc(){or2El.textContent='—';dpEl.textContent='—';dph2oEl.textContent='—';mcfEl.textContent='—';flagEl.textContent='—';}
function recalc(){
  const a=parseFloat(orificeEl.value);
  const up=upEl.value===''?NaN:parseFloat(upEl.value);
  const dn=dnEl.value===''?NaN:parseFloat(dnEl.value);

  if(isNaN(a)){ blankCalc(); return; }

  const or2=a*a; or2El.textContent=or2?or2.toFixed(4):'—';

  if(isNaN(up) || isNaN(dn)){ dpEl.textContent='—'; dph2oEl.textContent='—'; mcfEl.textContent='—'; flagEl.textContent='—'; return; }

  const dp = up - dn;
  const dpH2O = dp * 27.7;
  const mcf = (a>0 && up>0 && dpH2O>0) ? 0.2628 * or2 * Math.sqrt(up * dpH2O) : 0;

  dpEl.textContent=dp.toFixed(1);
  dph2oEl.textContent=dpH2O.toFixed(1);
  mcfEl.textContent = mcf ? mcf.toFixed(3) : '—';

  let flag='—';
  if(dp>=15 && mcf<1) flag='RED: Possible hydrate / line block';
  else if(dp>=10 && mcf<3) flag='YELLOW: Watch – d/p high, flow low';
  flagEl.textContent=flag;
}

/* --------- Field target math ---------- */
function targetKey(){ return `${dateEl.value}::${fieldSel.value}`; }
function loadTargets(){ try{ window._targets = JSON.parse(localStorage.getItem(TARGETS_KEY)||'{}'); }catch{ window._targets = {}; } }
function saveTargets(){ localStorage.setItem(TARGETS_KEY, JSON.stringify(window._targets||{})); }
function loadTargetForCurrent(){
  const key=targetKey(); const t=(window._targets||{})[key];
  fieldTargetEl.value = (t!==undefined && t!==null && t!=='') ? t : '';
}
function saveTargetForCurrent(){
  const key=targetKey(); window._targets = window._targets || {};
  const v = fieldTargetEl.value===''? '' : Number(fieldTargetEl.value);
  window._targets[key]=v; saveTargets();
}
function fieldLiveMcf(){
  const v=mcfEl.textContent.trim(); return v && v!=='—' ? Number(v) : 0;
}
function updateFieldTotals(){
  const fld=fieldSel.value;
  const sum = (state.rows||[]).filter(r=>r.field===fld).reduce((s,r)=>s + (Number(r.mcf)||0), 0);
  // include current live calc (not yet added) in preview
  const preview = sum + fieldLiveMcf();
  const tgt = fieldTargetEl.value===''? NaN : Number(fieldTargetEl.value);
  fieldCurrentEl.textContent = preview ? preview.toFixed(3) : '—';
  fieldRemainEl.textContent = isNaN(tgt) ? '—' : (tgt - preview).toFixed(3);
}

/* --------- Table rows ---------- */
function addRow(){
  const row={date:dateEl.value,time:timeEl.value,attendant:attendantEl.value,field:fieldSel.value,
    well:wellSel.options[wellSel.selectedIndex]?.dataset.name||'',igs:igsEl.value,orifice:orificeEl.value,
    up:upEl.value,dn:dnEl.value,dp:dpEl.textContent.replace('—',''),dph2o:dph2oEl.textContent.replace('—',''),
    mcf:mcfEl.textContent.replace('—',''),mode:modeEl.value,line:lineEl.value,notes:notesEl.value};
  state.rows.push(row); renderRows(); status.textContent='Added'; afterChange();
}
function renderRows(){
  rowsTbody.innerHTML=''; state.rows.forEach(r=>{
    const tr=document.createElement('tr'); const dp=+r.dp, mcf=+r.mcf;
    if(dp>=15 && mcf<1) tr.classList.add('flag-red'); else if(dp>=10 && mcf<3) tr.classList.add('flag-yellow');
    tr.innerHTML=`<td>${e(r.date)}</td><td>${e(r.time)}</td><td>${e(r.attendant)}</td><td>${e(r.field)}</td><td>${e(r.well)}</td><td>${e(r.igs)}</td>
      <td>${e(r.orifice)}</td><td>${e(r.up)}</td><td>${e(r.dn)}</td><td>${e(r.dp)}</td><td>${e(r.dph2o)}</td><td>${e(r.mcf)}</td>
      <td>${e(r.mode)}</td><td>${e(r.line)}</td><td>${e(r.notes)}</td>`; rowsTbody.appendChild(tr);
  });
  updateFieldTotals();
}

/* --------- CSV helpers ---------- */
function exportCSV(rows, filename){
  const headers=["Date","Time","Attendant","Field","Well","IGS_ID","Orifice (in)","Upstream PSI","Downstream PSI","DeltaP psi","DeltaP H2O","MCF/hour","Mode","Line Group","Notes"];
  const csv=[headers,...rows.map(r=>[r.date,r.time,r.attendant,r.field,r.well,r.igs,r.orifice,r.up,r.dn,r.dp,r.dph2o,r.mcf,r.mode,r.line,r.notes])]
    .map(cols=>cols.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
  download(csv, filename);
}
function download(text, name){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([text],{type:'text/csv;charset=utf-8;'}));
  a.download=name; a.click();
}
function importCSV(evt){
  const f=evt.target.files?.[0]; if(!f) return; const r=new FileReader();
  r.onload=()=>{const t=r.result, L=t.split(/\r?\n/).filter(l=>l.trim().length); if(!L.length) return;
    for(let i=1;i<L.length;i++){const c=parseCSV(L[i]); if(!c) continue;
      state.rows.push({date:c[0],time:c[1],attendant:c[2],field:c[3],well:c[4],igs:c[5],orifice:c[6],up:c[7],dn:c[8],dp:c[9],dph2o:c[10],mcf:c[11],mode:c[12],line:c[13],notes:c[14]});
    } renderRows(); status.textContent='Imported'; evt.target.value=''; afterChange(); };
  r.readAsText(f);
}
function parseCSV(line){
  const out=[];let cur='';let q=false;for(let i=0;i<line.length;i++){
    const ch=line[i],nx=line[i+1]; if(ch=='"'&&q&&nx=='"'){cur+='"';i++;continue;}
    if(ch=='"'){q=!q;continue;} if(ch==','&&!q){out.push(cur);cur='';continue;} cur+=ch;
  } out.push(cur); return out;
}
function today(){return new Date().toISOString().slice(0,10);}

/* --------- Autosave ---------- */
function saveState(){ localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(state.rows||[])); }
function loadState(){
  try{
    const raw=localStorage.getItem(AUTOSAVE_KEY);
    if(!raw) return;
    const rows=JSON.parse(raw);
    if(Array.isArray(rows)){ state.rows=rows; renderRows(); status.textContent='Restored autosave'; }
  }catch(e){ console.warn('Autosave restore failed', e); }
}
function afterChange(){ saveState(); }

/* --------- Files (localStorage) ---------- */
function loadFiles(){ window._files = JSON.parse(localStorage.getItem(FILES_KEY)||'[]'); renderFiles(); }
function saveFiles(){ localStorage.setItem(FILES_KEY, JSON.stringify(window._files||[])); renderFiles(); }
function renderFiles(){
  filesBox.innerHTML='';
  const arr=window._files||[];
  if(!arr.length){ filesBox.innerHTML='<small>No saved files yet. Use “Save Field → Files” or “Save Bundle”.</small>'; return; }
  arr.forEach((f,idx)=>{
    const row=document.createElement('div'); row.className='file-row';
    row.innerHTML = `<div><strong>${e(f.name)}</strong><br><small>${e(f.meta||'CSV')}</small></div>
      <div>
        <button class="secondary" onclick="download(atob('${btoa(f.content)}'),'${e(f.name)}')">Download</button>
        <button class="secondary" onclick="delFile(${idx})">Delete</button>
      </div>`;
    filesBox.appendChild(row);
  });
}
function delFile(i){ window._files.splice(i,1); saveFiles(); }

/* Save current field into Files */
function saveCurrentFieldToFiles(){
  const fld=fieldSel.value;
  const rows = state.rows.filter(r=>r.field===fld);
  if(!rows.length){ status.textContent='No rows for this field yet'; return; }
  const fname = `${fld.replace(/\s+/g,'_')}_Daily_${today()}.csv`;
  const headers=["Date","Time","Attendant","Field","Well","IGS_ID","Orifice (in)","Upstream PSI","Downstream PSI","DeltaP psi","DeltaP H2O","MCF/hour","Mode","Line Group","Notes"];
  const csv=[headers,...rows.map(r=>[r.date,r.time,r.attendant,r.field,r.well,r.igs,r.orifice,r.up,r.dn,r.dp,r.dph2o,r.mcf,r.mode,r.line,r.notes])]
    .map(cols=>cols.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
  window._files = window._files || [];
  window._files.push({name:fname, content:csv, meta:`${fld} • ${rows.length} rows • ${today()}`});
  saveFiles(); status.textContent='Saved to Files'; afterChange();
}

/* Save ALL rows as one bundle file */
function saveBundleToFiles(){
  if (!state.rows.length){ status.textContent='No rows to save.'; return; }
  const fname = `Daily_Bundle_${today()}.csv`;
  const headers=["Date","Time","Attendant","Field","Well","IGS_ID","Orifice (in)","Upstream PSI","Downstream PSI","DeltaP psi","DeltaP H2O","MCF/hour","Mode","Line Group","Notes"];
  const csv=[headers,...state.rows.map(r=>[r.date,r.time,r.attendant,r.field,r.well,r.igs,r.orifice,r.up,r.dn,r.dp,r.dph2o,r.mcf,r.mode,r.line,r.notes])]
    .map(cols=>cols.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
  window._files = window._files || [];
  window._files.push({name:fname, content:csv, meta:`All fields • ${state.rows.length} rows • ${today()}`});
  saveFiles(); status.textContent='Bundle saved to Files'; afterChange();
}

/* Download all saved files (each as its own CSV) */
function downloadAllFiles(){
  const arr=window._files||[]; if(!arr.length){status.textContent='No files to download'; return;}
  arr.forEach(f=>download(f.content, f.name));
  status.textContent='Downloading all files…';
}

/* Reset the day (clear rows + autosave) */
function resetDay(){
  if(!confirm('Clear all rows for today? Make sure you saved/exported first.')) return;
  state.rows = []; renderRows(); saveState(); status.textContent='Cleared'; updateFieldTotals();
}

/* utils */
function e(s){return String(s??'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
</script>
</body>
</html>
