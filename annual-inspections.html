<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FieldFlow — Files</title>
<style>
  :root{--bg:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--line:rgba(255,255,255,.12);--accent:#38bdf8;--r:14px;--shadow:0 10px 30px rgba(0,0,0,.35)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:18px;text-align:center;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01))}
  h1{margin:6px 0 2px;font-size:22px}
  .muted{color:var(--muted);font-size:13px}
  main{max-width:1080px;margin:18px auto 100px;padding:0 14px}
  .filters{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  @media(max-width:1000px){.filters{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:560px){.filters{grid-template-columns:1fr}}
  select, input{background:#0a0f1f;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px;font-size:14px;width:100%}
  .toolbar{position:sticky;top:0;background:rgba(10,15,31,.9);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;z-index:50}
  .list{margin-top:14px}
  .item{border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-bottom:10px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); box-shadow:var(--shadow)}
  .head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:rgba(255,255,255,.04);cursor:pointer}
  .head-left{display:flex;align-items:center;gap:10px}
  .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .body{display:none;padding:12px;background:rgba(0,0,0,.25)}
  .open .body{display:block}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  button{background:linear-gradient(180deg,rgba(56,189,248,.25),rgba(56,189,248,.12));border:1px solid rgba(56,189,248,.5);color:white;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
  button.secondary{background:transparent;border:1px solid var(--line);color:var(--ink)}
  .home{position:fixed;right:16px;bottom:16px}
  .empty{padding:16px;border:1px dashed var(--line);border-radius:12px;color:var(--muted);text-align:center;margin-top:14px}
  .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(max-width:720px){.grid2{grid-template-columns:1fr}}
  pre{white-space:pre-wrap;word-wrap:break-word;background:#0a0f1f;border:1px solid var(--line);padding:10px;border-radius:10px}
  .batchTag{font-size:11px;padding:2px 6px;border:1px solid var(--line);border-radius:999px}
  input[type="checkbox"]{width:18px;height:18px}
  .pill{font-size:11px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted)}
  .danger{background:linear-gradient(180deg,rgba(239,68,68,.25),rgba(239,68,68,.12));border:1px solid rgba(239,68,68,.5)}
</style>
</head>
<body>
<header>
  <h1>Files Archive</h1>
  <div class="muted">Multi-select entries • Combined CSV/email • Delete single or bulk</div>
</header>
<main>
  <div class="filters">
    <select id="typeFilter">
      <option value="">All Types</option>
      <option>Annual Inspection</option>
      <option>Daily Pressure</option>
      <option>Shut-In</option>
      <option>OBS Reading</option>
      <option>Well Status</option>
      <option>SWD</option>
      <option>Daily Activity</option>
    </select>
    <select id="fieldFilter"><option value="">All Fields</option></select>
    <select id="wellFilter"><option value="">All Wells</option></select>
    <input id="dateFilter" type="date" />
    <select id="attFilter"><option value="">All Attendants</option><option>T. Cherry</option><option>T. Ressler</option></select>
  </div>

  <!-- Bulk toolbar -->
  <div class="toolbar">
    <button id="selectAllBtn" type="button">Select All</button>
    <button id="clearSelBtn" class="secondary" type="button">Clear</button>
    <span class="pill" id="selCount">0 selected</span>
    <div style="flex:1"></div>
    <button id="bulkCsvBtn" type="button">Download CSV (Combined)</button>
    <button id="bulkEmailBtn" type="button">Email Summary (Combined)</button>
    <button id="bulkDeleteBtn" class="danger" type="button">Delete Selected</button>
  </div>

  <div class="list" id="list"></div>
  <div class="empty" id="empty">No records yet. Use “Save All Visible (Combined)” on each section page to create batch files here.</div>

  <a class="home" href="index.html"><button class="secondary">← Home</button></a>
</main>

<script>
/* ================= Storage helpers ================= */
const LS = {
  annualRecordsKey: "annualInspections",
  annualBatchesKey: "annualInspectionBatches",
  loadAnnualRecords(){ return JSON.parse(localStorage.getItem(this.annualRecordsKey) || "[]"); },
  loadAnnualBatches(){ return JSON.parse(localStorage.getItem(this.annualBatchesKey) || "[]"); },
  saveAnnualRecords(arr){ localStorage.setItem(this.annualRecordsKey, JSON.stringify(arr)); },
  saveAnnualBatches(arr){ localStorage.setItem(this.annualBatchesKey, JSON.stringify(arr)); }
};

// Create stable keys for deleting specific items
function recKey(r){
  // Use savedAt if present; fall back to combo
  return `REC|${r.recordType}|${r.field}|${r.well}|${r.date}|${r.attendant||""}|${r.savedAt||""}`;
}
function batchKey(b){
  return `BAT|${b.batchId||""}|${b.recordType}|${b.field}|${b.date}|${b.attendant||""}|${b.count}`;
}

function loadAll(){
  const recs = LS.loadAnnualRecords().map(r => ({...r, __key: recKey(r)}));
  const bats = LS.loadAnnualBatches().map(b => ({...b, __key: batchKey(b)}));
  return {records: recs, batches: bats};
}

let {records: allRecords, batches: allBatches} = loadAll();

/* ================= UI helpers ================= */
const unique = arr => Array.from(new Set(arr.filter(Boolean)));
function recordTitle(r){
  const dt = r.date || (r.savedAt ? r.savedAt.slice(0,10) : "");
  return `${r.recordType || 'Record'} — ${r.field || 'Field'} / ${r.well || 'Well'} — ${dt}`;
}
function batchTitle(b){
  return `${b.recordType} — ${b.field} — ${b.count} wells — ${b.date}`;
}
function recordMeta(r){
  const parts = [];
  if (r.wellType) parts.push(r.wellType);
  if (r.attendant) parts.push(r.attendant);
  if (r.date) parts.push(r.date);
  return parts.join(" • ");
}

/* ================= CSV (Annuals wired) ================= */
const ANNUAL_KEYS = ["recordType","wellType","field","well","date","attendant","surfacePSI","casingPSI","valves","leaks","notes"];
const esc = v => `"${String(v??"").replace(/"/g,'""')}"`;
function toCSVRow(obj, keys){
  return keys.map(k => typeof obj[k]==="object" ? esc(JSON.stringify(obj[k])) : esc(obj[k])).join(",");
}
function batchToAnnualRows(batch){ return batch.entries.map(e => toCSVRow(e, ANNUAL_KEYS)); }
function recordToAnnualRow(r){ return toCSVRow(r, ANNUAL_KEYS); }

/* ================= Selection ================= */
const selection = new Set(); // tokens 'batch:<key>' or 'record:<key>'
function updateSelCount(){ document.getElementById("selCount").textContent = `${selection.size} selected`; }
function selectAll(){
  selection.clear();
  document.querySelectorAll('input[type="checkbox"][data-sel]').forEach(cb=>{ cb.checked = true; selection.add(cb.dataset.sel); });
  updateSelCount();
}
function clearSel(){
  selection.clear();
  document.querySelectorAll('input[type="checkbox"][data-sel]').forEach(cb=>cb.checked=false);
  updateSelCount();
}

/* ================= Render ================= */
function initFilters(){
  const fields = unique([...allRecords.map(r=>r.field), ...allBatches.map(b=>b.field)]);
  const wells = unique(allRecords.map(r=>r.well));
  const fieldSel = document.getElementById("fieldFilter");
  const wellSel = document.getElementById("wellFilter");
  fields.forEach(f => fieldSel.appendChild(new Option(f,f)));
  wells.forEach(w => wellSel.appendChild(new Option(w,w)));
}

function render(records, batches){
  const list = document.getElementById("list");
  const empty = document.getElementById("empty");
  list.innerHTML = "";
  empty.style.display = (records.length || batches.length) ? "none" : "block";

  // Batches
  batches.forEach(b=>{
    const item = document.createElement("div"); item.className="item";
    const head = document.createElement("div"); head.className="head";

    const left = document.createElement("div"); left.className="head-left";
    const cb = document.createElement("input"); cb.type="checkbox"; cb.dataset.sel=`batch:${b.__key}`;
    cb.addEventListener("click", e=>{ e.stopPropagation(); cb.checked? selection.add(cb.dataset.sel): selection.delete(cb.dataset.sel); updateSelCount(); });
    const title = document.createElement("div"); title.innerHTML = `${batchTitle(b)} <span class="batchTag">Batch</span>`;
    left.appendChild(cb); left.appendChild(title);

    const meta = document.createElement("div"); meta.className="meta"; meta.textContent=[b.wellType,b.attendant,b.date].filter(Boolean).join(" • ");
    head.appendChild(left); head.appendChild(meta);
    head.addEventListener("click", ()=> item.classList.toggle("open"));

    const body = document.createElement("div"); body.className="body";
    const grid = document.createElement("div"); grid.className="grid2";
    const pretty = document.createElement("pre"); pretty.textContent = JSON.stringify(b,null,2);
    grid.appendChild(pretty);

    const btns = document.createElement("div"); btns.className="btns";
    const csvBtn = btn("Download CSV (Combined)", ()=> downloadCSV([["\ufeff"+ANNUAL_KEYS.join(","), ...batchToAnnualRows(b)].join("\n")], `${batchTitle(b)}.csv`));
    const emailBtn = btn("Email (Combined)", ()=>{
      const subject = encodeURIComponent("Underground Storage Field Reports — Annual Inspections (Combined)");
      const headTxt = `Section: ${b.recordType}\nField: ${b.field}\nDate: ${b.date}\nAtt
