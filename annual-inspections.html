<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>FieldFlow – Annual Inspections</title>
<style>
  :root{--ink:#e5e7eb;--muted:#9ca3af;--pri:#0B5FFF}
  html,body{margin:0;background:#0b1220;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:linear-gradient(90deg,#0B5FFF22,#12B88622)}
  h1{font-size:18px;margin:0}
  .wrap{max-width:1200px;margin:16px auto;padding:0 12px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:10px;padding:12px 14px;margin-bottom:14px}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .grid .full{grid-column:1/-1}
  label{font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:6px}
  input,select{background:#0b1220;border:1px solid #1f2937;color:var(--ink);border-radius:8px;padding:10px 12px;font-size:14px;outline:none}
  input:focus,select:focus{border-color:var(--pri)}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{background:#0B5FFF;border:none;color:white;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.secondary{background:#0b1220;border:1px solid #1f2937}
  button.warn{background:#b91c1c}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1f2937;padding:8px 6px;font-size:12px;text-align:left;vertical-align:middle}
  th{color:#9fb2ff;position:sticky;top:0;background:#111827}
  .files-list{display:flex;flex-direction:column;gap:8px}
  .file-row{display:flex;justify-content:space-between;align-items:center;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:8px 10px}
  .file-row small{color:#9ca3af}
  .btn-row{background:#0b1220;border:1px solid #374151;color:#e5e7eb;border-radius:6px;padding:6px 10px;cursor:pointer}
  .btn-row:hover{border-color:#4b5563}
</style>
</head>
<body>
<header><h1>FieldFlow – Annual Inspections</h1><span id="status" style="opacity:.75">Ready</span></header>

<div class="wrap">
  <div class="card">
    <div class="grid">
      <label>Attendant
        <select id="attendant"><option value="T. Cherry">T. Cherry</option><option>Operator A</option><option>Operator B</option></select>
      </label>
      <label>Date <input type="date" id="date"></label>
      <label>Time <input type="time" id="time"></label>

      <label>Type
        <select id="type">
          <option value="PROD" selected>Production</option>
          <option value="OBS">OBS</option>
        </select>
      </label>

      <label>Field <select id="field"></select></label>
      <label>Well (filtered) <select id="well"></select></label>
      <label>IGS ID (auto) <input id="igs" type="text" placeholder="(auto)" readonly></label>
      <label>OBS Well?
        <select id="isObs"><option value="No" selected>No</option><option>Yes</option></select>
      </label>

      <label>Surface PSI <input id="surf" type="number" step="0.1" inputmode="decimal"></label>
      <label>Annulus PSI <input id="ann" type="number" step="0.1" inputmode="decimal"></label>
      <div></div><div></div>

      <!-- Valve FUNCTION (Yes/No) -->
      <label>Master – Function
        <select id="f_master"><option selected>Yes</option><option>No</option></select>
      </label>
      <label>Tubing – Function
        <select id="f_tubing"><option selected>Yes</option><option>No</option></select>
      </label>
      <label>Annulus – Function
        <select id="f_annulus"><option selected>Yes</option><option>No</option></select>
      </label>
      <label>Crossover – Function
        <select id="f_crossover"><option selected>Yes</option><option>No</option></select>
      </label>
      <label>Tail – Function
        <select id="f_tail"><option selected>Yes</option><option>No</option></select>
      </label>
      <label>Wing – Function
        <select id="f_wing"><option selected>Yes</option><option>No</option></select>
      </label>

      <!-- Valve LEAK (Yes/No) -->
      <label>Master – Leak
        <select id="l_master"><option value="No" selected>No</option><option>Yes</option></select>
      </label>
      <label>Tubing – Leak
        <select id="l_tubing"><option value="No" selected>No</option><option>Yes</option></select>
      </label>
      <label>Annulus – Leak
        <select id="l_annulus"><option value="No" selected>No</option><option>Yes</option></select>
      </label>
      <label>Crossover – Leak
        <select id="l_crossover"><option value="No" selected>No</option><option>Yes</option></select>
      </label>
      <label>Tail – Leak
        <select id="l_tail"><option value="No" selected>No</option><option>Yes</option></select>
      </label>
      <label>Wing – Leak
        <select id="l_wing"><option value="No" selected>No</option><option>Yes</option></select>
      </label>

      <label class="full">Notes <input id="notes" type="text" placeholder="Optional remarks"></label>
    </div>

    <div class="actions">
      <button id="autofill">Auto‑Fill All Wells (Field + Type)</button>
      <button class="secondary" id="add">Add Selected Well</button>
      <button class="secondary" id="export">Export CSV (all rows)</button>
      <button class="secondary" id="saveField">Save Field → Files</button>
      <button class="secondary" id="saveBundle">Save Bundle (All Rows)</button>
      <button class="secondary" id="exportAllFiles">Download All Files</button>
      <button class="warn" id="resetRows">Reset Rows (clear table)</button>
      <label class="secondary" style="padding:8px 12px;border-radius:8px;cursor:pointer">
        Import CSV<input type="file" id="import" accept=".csv" style="display:none">
      </label>
    </div>
  </div>

  <div class="card" style="overflow:auto;max-height:60vh">
    <table>
      <thead>
      <tr>
        <th>Date</th><th>Time</th><th>Attendant</th><th>Type</th><th>Field</th><th>Well</th><th>IGS_ID</th><th>OBS</th>
        <th>Surface</th><th>Annulus</th>
        <th>Func M</th><th>Func T</th><th>Func A</th><th>Func X</th><th>Func Tail</th><th>Func Wing</th>
        <th>Leak M</th><th>Leak T</th><th>Leak A</th><th>Leak X</th><th>Leak Tail</th><th>Leak Wing</th>
        <th>Notes</th><th></th>
      </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Files</h3>
    <div id="files" class="files-list"></div>
  </div>
</div>

<script>
/* ================= WELL LISTS ================= */
// Production wells (with IGS) – order matches your sheets
const PROD_WELLS = [
  // DIXON
  { field:"Dixon", name:"Evans 7",  number:"118537", order:101 },
  { field:"Dixon", name:"Evans 8",  number:"118538", order:102 },
  { field:"Dixon", name:"Evans 3",  number:"118508", order:103 },
  { field:"Dixon", name:"Evans 10", number:"118507", order:104 },
  { field:"Dixon", name:"Evans 5",  number:"118536", order:105 },
  { field:"Dixon", name:"Evans 4-H",number:"118540", order:106 },
  { field:"Dixon", name:"Evans 6",  number:"118541", order:107 },
  { field:"Dixon", name:"Cory 8",   number:"118527", order:108 },
  { field:"Dixon", name:"Cory 4",   number:"118526", order:109 },
  { field:"Dixon", name:"Cory 2",   number:"118571", order:110 },
  { field:"Dixon", name:"Cory 7",   number:"118574", order:111 },
  { field:"Dixon", name:"Cory 3",   number:"118572", order:112 },
  { field:"Dixon", name:"Cory 6",   number:"118573", order:113 },
  { field:"Dixon", name:"Cory 5",   number:"118506", order:114 },
  { field:"Dixon", name:"Cory 1",   number:"118505", order:115 },

  // MINERAL CITY
  { field:"Mineral City", name:"Rollison 4", number:"118002", order:201 },
  { field:"Mineral City", name:"Rollison 1", number:"118016", order:202 },
  { field:"Mineral City", name:"Rollison 2", number:"118017", order:203 },
  { field:"Mineral City", name:"G. Axe 6",   number:"118005", order:204 },
  { field:"Mineral City", name:"Haines 4",   number:"117997", order:205 },
  { field:"Mineral City", name:"Haines 1",   number:"117994", order:206 },
  { field:"Mineral City", name:"Haines 2",   number:"117995", order:207 },
  { field:"Mineral City", name:"Haines 3",   number:"117996", order:208 },
  { field:"Mineral City", name:"G. Axe 1",   number:"118004", order:209 },
  { field:"Mineral City", name:"WS Allen 1", number:"117981", order:210 },
  { field:"Mineral City", name:"G. Axe 2",   number:"118088", order:211 },
  { field:"Mineral City", name:"G. Axe 4",   number:"118090", order:212 },
  { field:"Mineral City", name:"G. Axe 5",   number:"118091", order:213 },
  { field:"Mineral City", name:"G. Axe 3",   number:"118089", order:214 },
  { field:"Mineral City", name:"J. Axe 1",   number:"118093", order:215 },

  // SIMPSON CHAPEL
  { field:"Simpson Chapel", name:"Blaker 1", number:"118023", order:301 },
  { field:"Simpson Chapel", name:"Emery 2",  number:"118027", order:302 },
  { field:"Simpson Chapel", name:"Emery 1",  number:"118028", order:303 },
  { field:"Simpson Chapel", name:"Crays 8",  number:"118025", order:304 },
  { field:"Simpson Chapel", name:"Crays 1",  number:"118024", order:305 },
  { field:"Simpson Chapel", name:"Crays 5",  number:"118136", order:306 },
  { field:"Simpson Chapel", name:"Crays 4",  number:"118135", order:307 },
  { field:"Simpson Chapel", name:"Crays 3",  number:"118134", order:308 },
  { field:"Simpson Chapel", name:"Crays 7",  number:"118138", order:309 },
  { field:"Simpson Chapel", name:"Crays 2",  number:"118133", order:310 },
  { field:"Simpson Chapel", name:"Crays 6",  number:"118137", order:311 },
  { field:"Simpson Chapel", name:"Royal 6",  number:"118143", order:312 },
  { field:"Simpson Chapel", name:"Royal 5",  number:"118142", order:313 },
  { field:"Simpson Chapel", name:"Royal 4",  number:"118030", order:314 },
  { field:"Simpson Chapel", name:"Royal 7",  number:"118031", order:315 },
  { field:"Simpson Chapel", name:"Royal 1",  number:"118029", order:316 }
];

// OBS wells — IGS blank for now (fill later)
const OBS_WELLS = [
  // DIXON
  { field:"Dixon", name:"Evans 1", number:"", order:1001 },
  { field:"Dixon", name:"Evans 2", number:"", order:1002 },
  { field:"Dixon", name:"Evans 9", number:"", order:1003 },
  { field:"Dixon", name:"Hendren 1", number:"", order:1004 },
  { field:"Dixon", name:"Mount 1", number:"", order:1005 },
  { field:"Dixon", name:"Dowden 1", number:"", order:1006 },

  // MINERAL CITY
  { field:"Mineral City", name:"Horning 1", number:"", order:1101 },
  { field:"Mineral City", name:"G Axe 7", number:"", order:1102 },
  { field:"Mineral City", name:"Boruff 1", number:"", order:1103 },
  { field:"Mineral City", name:"Floyd 1", number:"", order:1104 },
  { field:"Mineral City", name:"Rollison 5", number:"", order:1105 },
  { field:"Mineral City", name:"Foster 1", number:"", order:1106 },

  // SIMPSON CHAPEL
  { field:"Simpson Chapel", name:"Blackmore 3", number:"", order:1201 },
  { field:"Simpson Chapel", name:"RH Stone 1", number:"", order:1202 },
  { field:"Simpson Chapel", name:"Royal 2", number:"", order:1203 },
  { field:"Simpson Chapel", name:"Royal 3", number:"", order:1204 },
  { field:"Simpson Chapel", name:"Rollison 5", number:"", order:1205 },
  { field:"Simpson Chapel", name:"Royal 9", number:"", order:1206 },
  { field:"Simpson Chapel", name:"S Blackmore 1", number:"", order:1207 },
  { field:"Simpson Chapel", name:"Blackmore 4", number:"", order:1208 },
  { field:"Simpson Chapel", name:"Royal 8", number:"", order:1209 }
];

const AUTOSAVE_KEY='ff_annual_autosave_v2';
const FILES_KEY='ff_files'; // share Files panel with Daily

const FIELDS=[...new Set([...PROD_WELLS,...OBS_WELLS].map(w=>w.field))];

const state={rows:[]};
const $=id=>document.getElementById(id);
const status=$('status');
const attendantEl=$('attendant'), dateEl=$('date'), timeEl=$('time'), typeEl=$('type'),
fieldSel=$('field'), wellSel=$('well'), igsEl=$('igs'), isObsEl=$('isObs'),
surfEl=$('surf'), annEl=$('ann'),
fM=$('f_master'), fT=$('f_tubing'), fA=$('f_annulus'), fX=$('f_crossover'), fTail=$('f_tail'), fWing=$('f_wing'),
lM=$('l_master'), lT=$('l_tubing'), lA=$('l_annulus'), lX=$('l_crossover'), lTail=$('l_tail'), lWing=$('l_wing'),
notesEl=$('notes'), rowsTbody=$('rows'), filesBox=$('files');

// init
FIELDS.forEach(f=>{const o=document.createElement('option');o.value=f;o.textContent=f;fieldSel.appendChild(o);});
(function initDT(){
  const n=new Date();
  dateEl.value=n.toISOString().slice(0,10);
  timeEl.value=String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0');
  refreshWellDropdown(); loadFiles(); loadState(); renderRows();
})();
typeEl.addEventListener('change', ()=>{refreshWellDropdown(); syncWellMeta();});
fieldSel.addEventListener('change', ()=>{refreshWellDropdown(); syncWellMeta();});
wellSel.addEventListener('change', ()=>syncWellMeta());
['input','change'].forEach(ev=>{
  [attendantEl,dateEl,timeEl,isObsEl,surfEl,annEl,fM,fT,fA,fX,fTail,fWing,lM,lT,lA,lX,lTail,lWing,notesEl]
    .forEach(el=>el.addEventListener(ev, saveState));
});

// buttons
$('add').addEventListener('click', addSelectedRow);
$('autofill').addEventListener('click', autoFillAllForField);
$('export').addEventListener('click', ()=>exportCSV(state.rows, `Annual_Inspections_${today()}.csv`));
$('import').addEventListener('change', importCSV);
$('saveField').addEventListener('click', saveCurrentFieldToFiles);
$('saveBundle').addEventListener('click', saveBundleToFiles);
$('exportAllFiles').addEventListener('click', downloadAllFiles);
$('resetRows').addEventListener('click', resetRows);
window.addEventListener('beforeunload', (e)=>{
  if (state.rows && state.rows.length){ saveState(); e.preventDefault(); e.returnValue=''; }
});

/* ---------- Helpers ---------- */
function listForType(){ return typeEl.value==='OBS' ? OBS_WELLS : PROD_WELLS; }
function wellsFor(field){ return listForType().filter(w=>w.field===field).sort((a,b)=>(a.order??0)-(b.order??0)); }
function refreshWellDropdown(){
  wellSel.innerHTML='';
  wellsFor(fieldSel.value).forEach(w=>{
    const opt=document.createElement('option');
    opt.value=w.number; opt.textContent=w.name; opt.dataset.name=w.name; opt.dataset.field=w.field;
    wellSel.appendChild(opt);
  });
}
function syncWellMeta(){
  const opt=wellSel.options[wellSel.selectedIndex];
  igsEl.value = opt ? opt.value : '';
  // OBS flag auto from type
  isObsEl.value = (typeEl.value==='OBS') ? 'Yes' : 'No';
}
function defaultValveStates(){
  // Function = Yes, Leak = No
  [fM,fT,fA,fX,fTail,fWing].forEach(el=>el.value='Yes');
  [lM,lT,lA,lX,lTail,lWing].forEach(el=>el.value='No');
}

/* ---------- Row ops ---------- */
function addSelectedRow(){
  defaultValveStates();
  const opt=wellSel.options[wellSel.selectedIndex];
  if(!opt){ status.textContent='Pick a field and well first.'; return; }
  const row = mkRow(opt.dataset.field, opt.dataset.name, opt.value, isObsEl.value);
  state.rows.push(row); renderRows(); saveState(); status.textContent='Added row';
}
function autoFillAllForField(){
  if(!fieldSel.value){ status.textContent='Choose a field first.'; return; }
  if(!confirm(`Auto-fill all ${typeEl.value==='OBS'?'OBS':'Production'} wells for ${fieldSel.value}? This adds rows to the table.`)) return;
  defaultValveStates();
  wellsFor(fieldSel.value).forEach(w=>{
    const row = mkRow(w.field, w.name, w.number, (typeEl.value==='OBS')?'Yes':'No');
    state.rows.push(row);
  });
  renderRows(); saveState(); status.textContent='Auto-filled wells';
}
function mkRow(field,name,igs,obsFlag){
  return {
    date:dateEl.value,time:timeEl.value,attendant:attendantEl.value,type:typeEl.value,
    field,well:name,igs:igs||'',obs:obsFlag||((typeEl.value==='OBS')?'Yes':'No'),
    surf:surfEl.value,ann:annEl.value,
    fM:fM.value,fT:fT.value,fA:fA.value,fX:fX.value,fTail:fTail.value,fWing:fWing.value,
    lM:lM.value,lT:lT.value,lA:lA.value,lX:lX.value,lTail:lTail.value,lWing:lWing.value,
    notes:notesEl.value
  };
}
function deleteRow(idx){
  if(!confirm('Delete this row?')) return;
  state.rows.splice(idx,1); renderRows(); saveState(); status.textContent='Row deleted';
}
function renderRows(){
  rowsTbody.innerHTML='';
  state.rows.forEach((r,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${e(r.date)}</td><td>${e(r.time)}</td><td>${e(r.attendant)}</td><td>${e(r.type)}</td><td>${e(r.field)}</td><td>${e(r.well)}</td><td>${e(r.igs)}</td><td>${e(r.obs)}</td>
      <td>${e(r.surf)}</td><td>${e(r.ann)}</td>
      <td>${e(r.fM)}</td><td>${e(r.fT)}</td><td>${e(r.fA)}</td><td>${e(r.fX)}</td><td>${e(r.fTail)}</td><td>${e(r.fWing)}</td>
      <td>${e(r.lM)}</td><td>${e(r.lT)}</td><td>${e(r.lA)}</td><td>${e(r.lX)}</td><td>${e(r.lTail)}</td><td>${e(r.lWing)}</td>
      <td>${e(r.notes)}</td>
      <td><button class="btn-row" onclick="deleteRow(${idx})">Delete</button></td>`;
    rowsTbody.appendChild(tr);
  });
}

/* ---------- CSV / Files ---------- */
function exportCSV(rows, filename){
  const headers=["Date","Time","Attendant","Type","Field","Well","IGS_ID","OBS",
    "Surface PSI","Annulus PSI",
    "Func Master","Func Tubing","Func Annulus","Func Crossover","Func Tail","Func Wing",
    "Leak Master","Leak Tubing","Leak Annulus","Leak Crossover","Leak Tail","Leak Wing",
    "Notes"];
  const csv=[headers,...rows.map(r=>[
    r.date,r.time,r.attendant,r.type,r.field,r.well,r.igs,r.obs,
    r.surf,r.ann,
    r.fM,r.fT,r.fA,r.fX,r.fTail,r.fWing,
    r.lM,r.lT,r.lA,r.lX,r.lTail,r.lWing,
    r.notes
  ])].map(cols=>cols.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
  download(csv, filename);
}
function download(text, name){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([text],{type:'text/csv;charset=utf-8;'}));
  a.download=name; a.click();
}
function importCSV(evt){
  const f=evt.target.files?.[0]; if(!f) return; const r=new FileReader();
  r.onload=()=>{const t=r.result, L=t.split(/\r?\n/).filter(l=>l.trim().length); if(!L.length) return;
    for(let i=1;i<L.length;i++){
      const c=parseCSV(L[i]); if(!c) continue;
      state.rows.push({
        date:c[0],time:c[1],attendant:c[2],type:c[3],field:c[4],well:c[5],igs:c[6],obs:c[7],
        surf:c[8],ann:c[9],
        fM:c[10],fT:c[11],fA:c[12],fX:c[13],fTail:c[14],fWing:c[15],
        lM:c[16],lT:c[17],lA:c[18],lX:c[19],lTail:c[20],lWing:c[21],
        notes:c[22]
      });
    } renderRows(); status.textContent='Imported'; evt.target.value=''; saveState();
  }; r.readAsText(f);
}
function parseCSV(line){
  const out=[];let cur='';let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i],nx=line[i+1];
    if(ch=='"'&&q&&nx=='"'){cur+='"';i++;continue;}
    if(ch=='"'){q=!q;continue;}
    if(ch==','&&!q){out.push(cur);cur='';continue;}
    cur+=ch;
  } out.push(cur); return out;
}

function today(){return new Date().toISOString().slice(0,10);}

/* ---------- Autosave ---------- */
function saveState(){ localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(state.rows||[])); }
function loadState(){
  try{
    const raw=localStorage.getItem(AUTOSAVE_KEY);
    if(!raw) return;
    const rows=JSON.parse(raw);
    if(Array.isArray(rows)){ state.rows=rows; }
  }catch(e){ console.warn('Autosave restore failed', e); }
}

/* ---------- Files (localStorage) ---------- */
function loadFiles(){ window._files = JSON.parse(localStorage.getItem(FILES_KEY)||'[]'); renderFiles(); }
function saveFiles(){ localStorage.setItem(FILES_KEY, JSON.stringify(window._files||[])); renderFiles(); }
function renderFiles(){
  filesBox.innerHTML='';
  const arr=window._files||[];
  if(!arr.length){ filesBox.innerHTML='<small>No saved files yet. Use “Save Field → Files” or “Save Bundle”.</small>'; return; }
  arr.forEach((f,idx)=>{
    const row=document.createElement('div'); row.className='file-row';
    row.innerHTML = `<div><strong>${e(f.name)}</strong><br><small>${e(f.meta||'CSV')}</small></div>
      <div><button class="secondary" onclick="download(atob('${btoa(f.content)}'),'${e(f.name)}')">Download</button>
           <button class="secondary" onclick="delFile(${idx})">Delete</button></div>`;
    filesBox.appendChild(row);
  });
}
function delFile(i){ window._files.splice(i,1); saveFiles(); }

function saveCurrentFieldToFiles(){
  const fld=fieldSel.value;
  const rows = state.rows.filter(r=>r.field===fld);
  if(!rows.length){ status.textContent='No rows for this field yet'; return; }
  const fname = `${fld.replace(/\s+/g,'_')}_Annual_${today()}.csv`;
  const headers=["Date","Time","Attendant","Type","Field","Well","IGS_ID","OBS",
    "Surface PSI","Annulus PSI",
    "Func Master","Func Tubing","Func Annulus","Func Crossover","Func Tail","Func Wing",
    "Leak Master","Leak Tubing","Leak Annulus","Leak Crossover","Leak Tail","Leak Wing",
    "Notes"];
  const csv=[headers,...rows.map(r=>[
    r.date,r.time,r.attendant,r.type,r.field,r.well,r.igs,r.obs,
    r.surf,r.ann,
    r.fM,r.fT,r.fA,r.fX,r.fTail,r.fWing,
    r.lM,r.lT,r.lA,r.lX,r.lTail,r.lWing,
    r.notes
  ])].map(cols=>cols.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
  window._files = window._files || [];
  window._files.push({name:fname, content:csv, meta:`${fld} • ${rows.length} rows • ${today()}`});
  saveFiles(); status.textContent='Saved to Files';
}
function saveBundleToFiles(){
  if (!state.rows.length){ status.textContent='No rows to save.'; return; }
  const fname = `Annual_Bundle_${today()}.csv`;
  const headers=["Date","Time","Attendant","Type","Field","Well","IGS_ID","OBS",
    "Surface PSI","Annulus PSI",
    "Func Master","Func Tubing","Func Annulus","Func Crossover","Func Tail","Func Wing",
    "Leak Master","Leak Tubing","Leak Annulus","Leak Crossover","Leak Tail","Leak Wing",
    "Notes"];
  const csv=[headers,...state.rows.map(r=>[
    r.date,r.time,r.attendant,r.type,r.field,r.well,r.igs,r.obs,
    r.surf,r.ann,
    r.fM,r.fT,r.fA,r.fX,r.fTail,r.fWing,
    r.lM,r.lT,r.lA,r.lX,r.lTail,r.lWing,
    r.notes
  ])].map(cols=>cols.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
  window._files = window._files || [];
  window._files.push({name:fname, content:csv, meta:`All fields • ${state.rows.length} rows • ${today()}`});
  saveFiles(); status.textContent='Bundle saved to Files';
}
function downloadAllFiles(){
  const arr=window._files||[]; if(!arr.length){status.textContent='No files to download'; return;}
  arr.forEach(f=>download(f.content, f.name));
  status.textContent='Downloading all files…';
}
function resetRows(){
  if(!confirm('Clear the table rows? Make sure you saved/exported first.')) return;
  state.rows=[]; renderRows(); saveState(); status.textContent='Rows cleared';
}

/* utils */
function e(s){return String(s??'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
</script>
</body>
</html>
