<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FieldFlow — Files</title>
<style>
  :root{--bg:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--line:rgba(255,255,255,.12);--accent:#38bdf8;--r:14px;--shadow:0 10px 30px rgba(0,0,0,.35)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:18px;text-align:center;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01))}
  h1{margin:6px 0 2px;font-size:22px}
  .muted{color:var(--muted);font-size:13px}
  main{max-width:1080px;margin:18px auto 60px;padding:0 14px}
  .filters{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  @media(max-width:1000px){.filters{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:560px){.filters{grid-template-columns:1fr}}
  select, input{background:#0a0f1f;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px;font-size:14px;width:100%}
  .list{margin-top:14px}
  .item{border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-bottom:10px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); box-shadow:var(--shadow)}
  .head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:rgba(255,255,255,.04);cursor:pointer}
  .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .body{display:none;padding:12px;background:rgba(0,0,0,.25)}
  .open .body{display:block}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  button{background:linear-gradient(180deg,rgba(56,189,248,.25),rgba(56,189,248,.12));border:1px solid rgba(56,189,248,.5);color:white;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
  button.secondary{background:transparent;border:1px solid var(--line);color:var(--ink)}
  .home{position:fixed;right:16px;bottom:16px}
  .empty{padding:16px;border:1px dashed var(--line);border-radius:12px;color:var(--muted);text-align:center;margin-top:14px}
  .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(max-width:720px){.grid2{grid-template-columns:1fr}}
  pre{white-space:pre-wrap;word-wrap:break-word;background:#0a0f1f;border:1px solid var(--line);padding:10px;border-radius:10px}
  .batchTag{font-size:11px;padding:2px 6px;border:1px solid var(--line);border-radius:999px}
</style>
</head>
<body>
<header>
  <h1>Files Archive</h1>
  <div class="muted">Section-wide combined files (one email/CSV per batch) + individual entries for detail</div>
</header>
<main>
  <div class="filters">
    <select id="typeFilter">
      <option value="">All Types</option>
      <option>Annual Inspection</option>
      <option>Daily Pressure</option>
      <option>Shut-In</option>
      <option>OBS Reading</option>
      <option>Well Status</option>
      <option>SWD</option>
      <option>Daily Activity</option>
    </select>
    <select id="fieldFilter"><option value="">All Fields</option></select>
    <select id="wellFilter"><option value="">All Wells</option></select>
    <input id="dateFilter" type="date" />
    <select id="attFilter"><option value="">All Attendants</option><option>T. Cherry</option><option>T. Ressler</option></select>
  </div>

  <div class="list" id="list"></div>
  <div class="empty" id="empty">No records yet. Use “Save All Visible (Combined)” on each section page to create batch files here.</div>

  <a class="home" href="index.html"><button class="secondary">← Home</button></a>
</main>

<script>
/** ========= Load from localStorage ========= **/
function loadAll() {
  const records = [];
  const batches = [];

  // Individual records (kept for detail searches)
  const annual = JSON.parse(localStorage.getItem("annualInspections") || "[]");
  records.push(...annual);

  // Combined batches
  const annualBatches = JSON.parse(localStorage.getItem("annualInspectionBatches") || "[]");
  batches.push(...annualBatches);

  // Future: add other sections (dailyPressure, shutInLogs, etc.)
  return {records, batches};
}

const {records: allRecords, batches: allBatches} = loadAll();
const unique = (arr) => Array.from(new Set(arr.filter(Boolean)));

function initFilters(){
  const fields = unique([...allRecords.map(r=>r.field), ...allBatches.map(b=>b.field)]);
  const wells = unique(allRecords.map(r=>r.well));
  const fieldSel = document.getElementById("fieldFilter");
  const wellSel = document.getElementById("wellFilter");
  fields.forEach(f => fieldSel.appendChild(new Option(f,f)));
  wells.forEach(w => wellSel.appendChild(new Option(w,w)));
}

function recordTitle(r){
  const dt = r.date || (r.savedAt ? r.savedAt.slice(0,10) : "");
  return `${r.recordType || 'Record'} — ${r.field || 'Field'} / ${r.well || 'Well'} — ${dt}`;
}
function batchTitle(b){
  return `${b.recordType} — ${b.field} — ${b.count} wells — ${b.date}`;
}
function recordMeta(r){
  const parts = [];
  if (r.wellType) parts.push(r.wellType);
  if (r.attendant) parts.push(r.attendant);
  if (r.date) parts.push(r.date);
  return parts.join(" • ");
}
function toCSVRow(obj, keys){
  const esc = v => `"${String(v??"").replace(/"/g,'""')}"`;
  return keys.map(k => {
    const v = obj[k];
    if (typeof v === "object") return esc(JSON.stringify(v));
    return esc(v);
  }).join(",");
}
function batchToCSV(batch){
  // Standardized columns for Annuals
  const keys = ["recordType","wellType","field","well","date","attendant","surfacePSI","casingPSI","valves","leaks","notes"];
  const header = keys.join(",");
  const rows = batch.entries.map(e => toCSVRow(e, keys));
  return [header, ...rows].join("\n");
}
function emailBody(obj){
  const lines = [];
  const pushKV = (k,v)=>lines.push(`${k}: ${typeof v==="object"? JSON.stringify(v,null,2): v}`);
  Object.entries(obj).forEach(([k,v])=>pushKV(k,v));
  return encodeURIComponent(lines.join("\n"));
}
function emailBodyForBatch(batch){
  const head = `Section: ${batch.recordType}\nField: ${batch.field}\nDate: ${batch.date}\nAttendant: ${batch.attendant}\nWells: ${batch.count}\n\nSummary:\n`;
  const lines = batch.entries.map(e => `- ${e.well}: Surf ${e.surfacePSI || 0} psi, Casing ${e.casingPSI || 0} psi`);
  return encodeURIComponent(head + lines.join("\n") + "\n\n(Attach the CSV you downloaded.)");
}

/** ========= Rendering ========= **/
function render(records, batches){
  const list = document.getElementById("list");
  const empty = document.getElementById("empty");
  list.innerHTML = "";

  const hasAny = records.length || batches.length;
  empty.style.display = hasAny ? "none" : "block";

  // 1) Render batches first (these are the one-click emails you want)
  batches.forEach(b => {
    const item = document.createElement("div");
    item.className = "item";
    const head = document.createElement("div");
    head.className = "head";
    head.innerHTML = `<div>${batchTitle(b)} <span class="batchTag">Batch</span></div>
                      <div class="meta">${[b.wellType, b.attendant, b.date].filter(Boolean).join(" • ")}</div>`;
    head.addEventListener("click", ()=> item.classList.toggle("open"));

    const body = document.createElement("div");
    body.className = "body";
    const grid = document.createElement("div");
    grid.className = "grid2";

    const pretty = document.createElement("pre");
    pretty.textContent = JSON.stringify(b, null, 2);
    grid.appendChild(pretty);

    const btns = document.createElement("div");
    btns.className = "btns";

    // Download CSV (Combined)
    const csvBtn = document.createElement("button");
    csvBtn.textContent = "Download CSV (Combined)";
    csvBtn.addEventListener("click", ()=>{
      const csv = batchToCSV(b);
      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = (batchTitle(b).replace(/\s+/g,"_") + ".csv");
      a.click(); URL.revokeObjectURL(url);
    });

    // Email (Combined)
    const emailBtn = document.createElement("button");
    emailBtn.textContent = "Email (Combined)";
    emailBtn.addEventListener("click", ()=>{
      const subject = encodeURIComponent("Underground Storage Field Reports — Annual Inspections (Combined)");
      const body = emailBodyForBatch(b);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
      // Note: mailto can't auto-attach files; download CSV first, then attach in your email app.
    });

    // Print (Combined)
    const printBtn = document.createElement("button");
    printBtn.textContent = "Print (Combined)";
    printBtn.addEventListener("click", ()=>{
      const w = window.open("", "_blank");
      const html = `
        <html><head><title>${batchTitle(b)}</title>
        <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:16px} pre{white-space:pre-wrap}</style>
        </head><body>
        <h2>${batchTitle(b)}</h2>
        <pre>${JSON.stringify(b,null,2)}</pre>
        </body></html>`;
      w.document.write(html); w.document.close(); w.focus(); w.print();
    });

    btns.appendChild(csvBtn);
    btns.appendChild(emailBtn);
    btns.appendChild(printBtn);
    grid.appendChild(btns);
    body.appendChild(grid);
    item.appendChild(head);
    item.appendChild(body);
    list.appendChild(item);
  });

  // 2) Render individual records (still searchable if you need a single well later)
  records.forEach(r => {
    const item = document.createElement("div");
    item.className = "item";
    const head = document.createElement("div");
    head.className = "head";
    head.innerHTML = `<div>${recordTitle(r)}</div><div class="meta">${recordMeta(r)}</div>`;
    head.addEventListener("click", ()=> item.classList.toggle("open"));

    const body = document.createElement("div");
    body.className = "body";
    const grid = document.createElement("div"); grid.className = "grid2";
    const pretty = document.createElement("pre");
    pretty.textContent = JSON.stringify(r, null, 2);
    grid.appendChild(pretty);

    const btns = document.createElement("div");
    btns.className = "btns";

    const csvBtn = document.createElement("button");
    csvBtn.textContent = "Download CSV";
    csvBtn.addEventListener("click", ()=>{
      const keys = Object.keys(r);
      const header = keys.join(",");
      const row = (function(){
        const esc = v => `"${String(v??"").replace(/"/g,'""')}"`;
        return keys.map(k => typeof r[k]==="object" ? esc(JSON.stringify(r[k])) : esc(r[k])).join(",");
      })();
      const csv = header + "\n" + row;
      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = (recordTitle(r).replace(/\s+/g,"_") + ".csv");
      a.click(); URL.revokeObjectURL(url);
    });

    const emailBtn = document.createElement("button");
    emailBtn.textContent = "Email";
    emailBtn.addEventListener("click", ()=>{
      const subject = encodeURIComponent("Underground Storage Field Reports");
      const body = emailBody(r);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    const printBtn = document.createElement("button");
    printBtn.textContent = "Print";
    printBtn.addEventListener("click", ()=>{
      const w = window.open("", "_blank");
      const html = `
        <html><head><title>${recordTitle(r)}</title>
        <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:16px} pre{white-space:pre-wrap}</style>
        </head><body>
        <h2>${recordTitle(r)}</h2>
        <pre>${JSON.stringify(r,null,2)}</pre>
        </body></html>`;
      w.document.write(html); w.document.close(); w.focus(); w.print();
    });

    btns.appendChild(csvBtn);
    btns.appendChild(emailBtn);
    btns.appendChild(printBtn);

    grid.appendChild(btns);
    body.appendChild(grid);
    item.appendChild(head);
    item.appendChild(body);
    list.appendChild(item);
  });
}

function applyFilters(){
  const t = document.getElementById("typeFilter").value;
  const f = document.getElementById("fieldFilter").value;
  const w = document.getElementById("wellFilter").value;
  const d = document.getElementById("dateFilter").value;
  const a = document.getElementById("attFilter").value;

  // Filter batches
  const batches = allBatches.filter(b=>{
    if (t && b.recordType !== t) return false;
    if (f && b.field !== f) return false;
    if (d && (b.date || "").slice(0,10) !== d) return false;
    if (a && b.attendant !== a) return false;
    return true;
  });

  // Filter individual records
  const records = allRecords.filter(r=>{
    if (t && r.recordType !== t) return false;
    if (f && r.field !== f) return false;
    if (w && r.well !== w) return false;
    if (d && (r.date || "").slice(0,10) !== d) return false;
    if (a && r.attendant !== a) return false;
    return true;
  });

  render(records, batches);
}

function wireFilters(){
  ["typeFilter","fieldFilter","wellFilter","dateFilter","attFilter"].forEach(id=>{
    document.getElementById(id).addEventListener("change", applyFilters);
  });
}

document.addEventListener("DOMContentLoaded", ()=>{
  initFilters();
  render(allRecords, allBatches);
  wireFilters();
});
</script>
</body>
</html>
