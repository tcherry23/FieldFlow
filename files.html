<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FieldFlow — Files</title>
<style>
  :root{--bg:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--line:rgba(255,255,255,.12);--accent:#38bdf8;--r:14px;--shadow:0 10px 30px rgba(0,0,0,.35)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:18px;text-align:center;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01))}
  h1{margin:6px 0 2px;font-size:22px}
  .muted{color:var(--muted);font-size:13px}
  main{max-width:1080px;margin:18px auto 100px;padding:0 14px}
  .filters{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  @media(max-width:1000px){.filters{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:560px){.filters{grid-template-columns:1fr}}
  select, input{background:#0a0f1f;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px;font-size:14px;width:100%}
  .toolbar{position:sticky;top:0;background:rgba(10,15,31,.9);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;z-index:50}
  .list{margin-top:14px}
  .item{border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-bottom:10px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); box-shadow:var(--shadow)}
  .head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:rgba(255,255,255,.04);cursor:pointer}
  .head-left{display:flex;align-items:center;gap:10px}
  .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .body{display:none;padding:12px;background:rgba(0,0,0,.25)}
  .open .body{display:block}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  button{background:linear-gradient(180deg,rgba(56,189,248,.25),rgba(56,189,248,.12));border:1px solid rgba(56,189,248,.5);color:white;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
  button.secondary{background:transparent;border:1px solid var(--line);color:var(--ink)}
  .home{position:fixed;right:16px;bottom:16px}
  .empty{padding:16px;border:1px dashed var(--line);border-radius:12px;color:var(--muted);text-align:center;margin-top:14px}
  .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(max-width:720px){.grid2{grid-template-columns:1fr}}
  pre{white-space:pre-wrap;word-wrap:break-word;background:#0a0f1f;border:1px solid var(--line);padding:10px;border-radius:10px}
  .batchTag{font-size:11px;padding:2px 6px;border:1px solid var(--line);border-radius:999px}
  input[type="checkbox"]{width:18px;height:18px}
  .pill{font-size:11px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>Files Archive</h1>
  <div class="muted">Multi-select any entries • One combined CSV/email • Batches show as a single file</div>
</header>
<main>
  <div class="filters">
    <select id="typeFilter">
      <option value="">All Types</option>
      <option>Annual Inspection</option>
      <option>Daily Pressure</option>
      <option>Shut-In</option>
      <option>OBS Reading</option>
      <option>Well Status</option>
      <option>SWD</option>
      <option>Daily Activity</option>
    </select>
    <select id="fieldFilter"><option value="">All Fields</option></select>
    <select id="wellFilter"><option value="">All Wells</option></select>
    <input id="dateFilter" type="date" />
    <select id="attFilter"><option value="">All Attendants</option><option>T. Cherry</option><option>T. Ressler</option></select>
  </div>

  <!-- Bulk toolbar -->
  <div class="toolbar">
    <button id="selectAllBtn" type="button">Select All</button>
    <button id="clearSelBtn" class="secondary" type="button">Clear</button>
    <span class="pill" id="selCount">0 selected</span>
    <div style="flex:1"></div>
    <button id="bulkCsvBtn" type="button">Download CSV (Combined)</button>
    <button id="bulkEmailBtn" type="button">Email Summary (Combined)</button>
  </div>

  <div class="list" id="list"></div>
  <div class="empty" id="empty">No records yet. Use “Save All Visible (Combined)” on each section page to create batch files here.</div>

  <a class="home" href="index.html"><button class="secondary">← Home</button></a>
</main>

<script>
/** ========= Load from localStorage ========= **/
function loadAll() {
  const records = [];
  const batches = [];

  // Individual records
  const annual = JSON.parse(localStorage.getItem("annualInspections") || "[]");
  records.push(...annual);

  // Combined batches
  const annualBatches = JSON.parse(localStorage.getItem("annualInspectionBatches") || "[]");
  batches.push(...annualBatches);

  // Future: add other sections when wired (dailyPressure, shutInLogs, etc.)
  return {records, batches};
}

let {records: allRecords, batches: allBatches} = loadAll();
const unique = (arr) => Array.from(new Set(arr.filter(Boolean)));

function initFilters(){
  const fields = unique([...allRecords.map(r=>r.field), ...allBatches.map(b=>b.field)]);
  const wells = unique(allRecords.map(r=>r.well));
  const fieldSel = document.getElementById("fieldFilter");
  const wellSel = document.getElementById("wellFilter");
  fields.forEach(f => fieldSel.appendChild(new Option(f,f)));
  wells.forEach(w => wellSel.appendChild(new Option(w,w)));
}

/** ========= Titles/Meta ========= **/
function recordTitle(r){
  const dt = r.date || (r.savedAt ? r.savedAt.slice(0,10) : "");
  return `${r.recordType || 'Record'} — ${r.field || 'Field'} / ${r.well || 'Well'} — ${dt}`;
}
function batchTitle(b){
  return `${b.recordType} — ${b.field} — ${b.count} wells — ${b.date}`;
}
function recordMeta(r){
  const parts = [];
  if (r.wellType) parts.push(r.wellType);
  if (r.attendant) parts.push(r.attendant);
  if (r.date) parts.push(r.date);
  return parts.join(" • ");
}

/** ========= CSV helpers (Annuals wired) ========= **/
const ANNUAL_KEYS = ["recordType","wellType","field","well","date","attendant","surfacePSI","casingPSI","valves","leaks","notes"];
function esc(v){ return `"${String(v??"").replace(/"/g,'""')}"`; }
function toCSVRow(obj, keys){
  return keys.map(k => {
    const v = obj[k];
    return typeof v === "object" ? esc(JSON.stringify(v)) : esc(v);
  }).join(",");
}
function batchToAnnualRows(batch){
  return batch.entries.map(e => toCSVRow(e, ANNUAL_KEYS));
}
function recordToAnnualRow(rec){
  return toCSVRow(rec, ANNUAL_KEYS);
}

/** ========= Selection state ========= **/
const selection = new Set(); // ids like type:batch|record + index
function updateSelCount(){
  document.getElementById("selCount").textContent = `${selection.size} selected`;
}
function selectAll(){
  selection.clear();
  document.querySelectorAll('input[type="checkbox"][data-sel]').forEach(cb=>{
    cb.checked = true; selection.add(cb.dataset.sel);
  });
  updateSelCount();
}
function clearSel(){
  selection.clear();
  document.querySelectorAll('input[type="checkbox"][data-sel]').forEach(cb=>cb.checked=false);
  updateSelCount();
}

/** ========= Rendering ========= **/
function render(records, batches){
  const list = document.getElementById("list");
  const empty = document.getElementById("empty");
  list.innerHTML = "";

  const hasAny = records.length || batches.length;
  empty.style.display = hasAny ? "none" : "block";

  // Batches first
  batches.forEach((b, i) => {
    const item = document.createElement("div");
    item.className = "item";
    const head = document.createElement("div");
    head.className = "head";

    const left = document.createElement("div");
    left.className = "head-left";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.dataset.sel = `batch:${i}`;
    cb.addEventListener("click", e => {
      e.stopPropagation();
      if (cb.checked) selection.add(cb.dataset.sel); else selection.delete(cb.dataset.sel);
      updateSelCount();
    });
    const title = document.createElement("div");
    title.innerHTML = `${batchTitle(b)} <span class="batchTag">Batch</span>`;

    left.appendChild(cb); left.appendChild(title);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = [b.wellType, b.attendant, b.date].filter(Boolean).join(" • ");

    head.appendChild(left);
    head.appendChild(meta);
    head.addEventListener("click", ()=> item.classList.toggle("open"));

    const body = document.createElement("div");
    body.className = "body";
    const grid = document.createElement("div");
    grid.className = "grid2";
    const pretty = document.createElement("pre");
    pretty.textContent = JSON.stringify(b, null, 2);
    grid.appendChild(pretty);

    const btns = document.createElement("div");
    btns.className = "btns";

    // Download CSV (Combined)
    const csvBtn = document.createElement("button");
    csvBtn.textContent = "Download CSV (Combined)";
    csvBtn.addEventListener("click", ()=>{
      const csv = ["\ufeff" + ANNUAL_KEYS.join(","), ...batchToAnnualRows(b)].join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = (batchTitle(b).replace(/\s+/g,"_") + ".csv");
      a.click(); URL.revokeObjectURL(url);
    });

    // Email (Combined) – summary text (attach CSV manually)
    const emailBtn = document.createElement("button");
    emailBtn.textContent = "Email (Combined)";
    emailBtn.addEventListener("click", ()=>{
      const subject = encodeURIComponent("Underground Storage Field Reports — Annual Inspections (Combined)");
      const headTxt = `Section: ${b.recordType}\nField: ${b.field}\nDate: ${b.date}\nAttendant: ${b.attendant}\nWells: ${b.count}\n\nSummary:\n`;
      const lines = b.entries.map(e => `- ${e.well}: Surf ${e.surfacePSI||0} psi, Casing ${e.casingPSI||0} psi`);
      const body = encodeURIComponent(headTxt + lines.join("\n") + "\n\n(Attach the CSV you downloaded.)");
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    // Print (Combined)
    const printBtn = document.createElement("button");
    printBtn.textContent = "Print (Combined)";
    printBtn.addEventListener("click", ()=>{
      const w = window.open("", "_blank");
      const html = `
        <html><head><title>${batchTitle(b)}</title>
        <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:16px} pre{white-space:pre-wrap}</style>
        </head><body>
        <h2>${batchTitle(b)}</h2>
        <pre>${JSON.stringify(b,null,2)}</pre>
        </body></html>`;
      w.document.write(html); w.document.close(); w.focus(); w.print();
    });

    btns.appendChild(csvBtn); btns.appendChild(emailBtn); btns.appendChild(printBtn);
    grid.appendChild(btns);
    body.appendChild(grid);
    item.appendChild(head);
    item.appendChild(body);
    list.appendChild(item);
  });

  // Individual records
  records.forEach((r, i) => {
    const item = document.createElement("div");
    item.className = "item";
    const head = document.createElement("div");
    head.className = "head";

    const left = document.createElement("div");
    left.className = "head-left";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.dataset.sel = `record:${i}`;
    cb.addEventListener("click", e => {
      e.stopPropagation();
      if (cb.checked) selection.add(cb.dataset.sel); else selection.delete(cb.dataset.sel);
      updateSelCount();
    });

    const title = document.createElement("div");
    title.textContent = recordTitle(r);
    left.appendChild(cb); left.appendChild(title);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = recordMeta(r);

    head.appendChild(left);
    head.appendChild(meta);
    head.addEventListener("click", ()=> item.classList.toggle("open"));

    const body = document.createElement("div");
    body.className = "body";
    const grid = document.createElement("div"); grid.className = "grid2";
    const pretty = document.createElement("pre");
    pretty.textContent = JSON.stringify(r, null, 2);
    grid.appendChild(pretty);

    const btns = document.createElement("div");
    btns.className = "btns";

    const csvBtn = document.createElement("button");
    csvBtn.textContent = "Download CSV";
    csvBtn.addEventListener("click", ()=>{
      const header = ANNUAL_KEYS.join(",");
      const row = recordToAnnualRow(r);
      const csv = "\ufeff" + header + "\n" + row;
      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = (recordTitle(r).replace(/\s+/g,"_") + ".csv");
      a.click(); URL.revokeObjectURL(url);
    });

    const emailBtn = document.createElement("button");
    emailBtn.textContent = "Email";
    emailBtn.addEventListener("click", ()=>{
      const subject = encodeURIComponent("Underground Storage Field Reports");
      const lines = ANNUAL_KEYS.map(k => `${k}: ${typeof r[k]==="object"? JSON.stringify(r[k],null,2): r[k]??""}`);
      const body = encodeURIComponent(lines.join("\n"));
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    const printBtn = document.createElement("button");
    printBtn.textContent = "Print";
    printBtn.addEventListener("click", ()=>{
      const w = window.open("", "_blank");
      const html = `
        <html><head><title>${recordTitle(r)}</title>
        <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:16px} pre{white-space:pre-wrap}</style>
        </head><body>
        <h2>${recordTitle(r)}</h2>
        <pre>${JSON.stringify(r,null,2)}</pre>
        </body></html>`;
      w.document.write(html); w.document.close(); w.focus(); w.print();
    });

    btns.appendChild(csvBtn); btns.appendChild(emailBtn); btns.appendChild(printBtn);
    grid.appendChild(btns);
    body.appendChild(grid);
    item.appendChild(head);
    item.appendChild(body);
    list.appendChild(item);
  });

  // Reset selection whenever we re-render
  clearSel();
}

/** ========= Filters ========= **/
function applyFilters(){
  const t = document.getElementById("typeFilter").value;
  const f = document.getElementById("fieldFilter").value;
  const w = document.getElementById("wellFilter").value;
  const d = document.getElementById("dateFilter").value;
  const a = document.getElementById("attFilter").value;

  const batches = allBatches.filter(b=>{
    if (t && b.recordType !== t) return false;
    if (f && b.field !== f) return false;
    if (d && (b.date || "").slice(0,10) !== d) return false;
    if (a && b.attendant !== a) return false;
    return true;
  });

  const records = allRecords.filter(r=>{
    if (t && r.recordType !== t) return false;
    if (f && r.field !== f) return false;
    if (w && r.well !== w) return false;
    if (d && (r.date || "").slice(0,10) !== d) return false;
    if (a && r.attendant !== a) return false;
    return true;
  });

  render(records, batches);
}

function wireFilters(){
  ["typeFilter","fieldFilter","wellFilter","dateFilter","attFilter"].forEach(id=>{
    document.getElementById(id).addEventListener("change", applyFilters);
  });
}

/** ========= Bulk actions ========= **/
function getSelected(records, batches){
  // selection contains tokens like "batch:2" or "record:5" (index in current allBatches/allRecords)
  const chosen = {records:[], batches:[]};
  selection.forEach(tok=>{
    const [kind, idxStr] = tok.split(":");
    const idx = Number(idxStr);
    if (kind === "batch" && allBatches[idx]) chosen.batches.push(allBatches[idx]);
    if (kind === "record" && allRecords[idx]) chosen.records.push(allRecords[idx]);
  });
  return chosen;
}

function bulkCSV(){
  const chosen = getSelected();
  const rows = [];
  // Header
  const header = ANNUAL_KEYS.join(",");
  // Expand batches
  chosen.batches.forEach(b => rows.push(...batchToAnnualRows(b)));
  // Add individual records
  chosen.records.forEach(r => rows.push(recordToAnnualRow(r)));

  if (!rows.length){ alert("Select some entries first."); return; }

  const csv = "\ufeff" + [header, ...rows].join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const dt = new Date().toISOString().slice(0,10);
  a.href = url; a.download = `FieldFlow_Combined_${dt}.csv`;
  a.click(); URL.revokeObjectURL(url);
}

function bulkEmail(){
  const chosen = getSelected();
  if (!chosen.batches.length && !chosen.records.length){ alert("Select some entries first."); return; }

  // Build a readable summary body (CSV needs manual attach)
  const lines = [];
  if (chosen.batches.length){
    lines.push("== Combined Batches ==");
    chosen.batches.forEach(b=>{
      lines.push(`${b.recordType} — ${b.field} — ${b.count} wells — ${b.date} — ${b.attendant || ""}`);
    });
    lines.push("");
  }
  if (chosen.records.length){
    lines.push("== Individual Records ==");
    chosen.records.forEach(r=>{
      lines.push(`${r.recordType} — ${r.field}/${r.well} — ${r.date} — ${r.attendant || ""}`);
    });
    lines.push("");
  }
  lines.push("(Attach the combined CSV you downloaded.)");

  const subject = encodeURIComponent("Underground Storage Field Reports — Combined");
  const body = encodeURIComponent(lines.join("\n"));
  window.location.href = `mailto:?subject=${subject}&body=${body}`;
}

document.addEventListener("DOMContentLoaded", ()=>{
  initFilters();
  render(allRecords, allBatches);
  wireFilters();

  document.getElementById("selectAllBtn").addEventListener("click", selectAll);
  document.getElementById("clearSelBtn").addEventListener("click", clearSel);
  document.getElementById("bulkCsvBtn").addEventListener("click", bulkCSV);
  document.getElementById("bulkEmailBtn").addEventListener("click", bulkEmail);
});
</script>
</body>
</html>
