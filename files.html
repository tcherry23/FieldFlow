<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FieldFlow — Files</title>
<style>
  :root{
    --bg:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--line:rgba(255,255,255,.12);
    --accent:#38bdf8;--danger:#ef4444;--r:14px;--shadow:0 10px 30px rgba(0,0,0,.35)
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:18px;text-align:center;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01))}
  h1{margin:6px 0 2px;font-size:22px}
  .muted{color:var(--muted);font-size:13px}
  main{max-width:1080px;margin:18px auto 110px;padding:0 14px}
  .filters{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  @media(max-width:1000px){.filters{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:560px){.filters{grid-template-columns:1fr}}
  select, input{background:#0a0f1f;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px;font-size:14px;width:100%}
  .toolbar{position:sticky;top:0;background:rgba(10,15,31,.9);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;z-index:50}
  .list{margin-top:14px}
  .item{border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-bottom:10px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); box-shadow:var(--shadow)}
  .head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:rgba(255,255,255,.04);cursor:pointer}
  .head-left{display:flex;align-items:center;gap:10px}
  .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .body{display:none;padding:12px;background:rgba(0,0,0,.25)}
  .open .body{display:block}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  button{background:linear-gradient(180deg,rgba(56,189,248,.25),rgba(56,189,248,.12));border:1px solid rgba(56,189,248,.5);color:white;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
  button.secondary{background:transparent;border:1px solid var(--line);color:var(--ink)}
  button.danger{background:linear-gradient(180deg,rgba(239,68,68,.25),rgba(239,68,68,.12));border:1px solid rgba(239,68,68,.5)}
  .home{position:fixed;right:16px;bottom:16px}
  .empty{padding:16px;border:1px dashed var(--line);border-radius:12px;color:var(--muted);text-align:center;margin-top:14px}
  .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(max-width:720px){.grid2{grid-template-columns:1fr}}
  pre{white-space:pre-wrap;word-wrap:break-word;background:#0a0f1f;border:1px solid var(--line);padding:10px;border-radius:10px}
  .batchTag{font-size:11px;padding:2px 6px;border:1px solid var(--line);border-radius:999px}
  input[type="checkbox"]{width:18px;height:18px}
  .pill{font-size:11px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>Files Archive</h1>
  <div class="muted">Multi-select entries • Combined CSV/email • Delete single or bulk</div>
</header>
<main>
  <div class="filters">
    <select id="typeFilter">
      <option value="">All Types</option>
      <option>Annual Inspection</option>
      <option>Daily Pressure</option>
      <option>Shut-In</option>
      <option>OBS Reading</option>
      <option>Well Status</option>
      <option>SWD</option>
      <option>Daily Activity</option>
    </select>
    <select id="fieldFilter"><option value="">All Fields</option></select>
    <select id="wellFilter"><option value="">All Wells</option></select>
    <input id="dateFilter" type="date" />
    <select id="attFilter"><option value="">All Attendants</option><option>T. Cherry</option><option>T. Ressler</option></select>
  </div>

  <div class="toolbar">
    <button id="selectAllBtn" type="button">Select All</button>
    <button id="clearSelBtn" class="secondary" type="button">Clear</button>
    <span class="pill" id="selCount">0 selected</span>
    <div style="flex:1"></div>
    <button id="bulkCsvBtn" type="button">Download CSV (Combined)</button>
    <button id="bulkEmailBtn" type="button">Email Summary (Combined)</button>
    <button id="bulkDeleteBtn" class="danger" type="button">Delete Selected</button>
  </div>

  <div class="list" id="list"></div>
  <div class="empty" id="empty">No records yet. Use “Save All Visible (Combined)” on each section page to create batch files here.</div>

  <a class="home" href="index.html"><button class="secondary">← Home</button></a>
</main>

<script>
/* ========= Storage keys for all sections ========= */
const KEYS = {
  annualRecords: "annualInspections",
  annualBatches: "annualInspectionBatches",
  dpRecords: "dailyPressure",
  dpBatches: "dailyPressureBatches",
  shutRecords: "shutInLogs",
  shutBatches: "shutInBatches",
  obsRecords: "obsReadings",
  obsBatches: "obsReadingBatches",
  statusRecords: "wellStatus",
  statusBatches: "wellStatusBatches",
  swdRecords: "swdLogs",
  swdBatches: "swdBatches",
  actRecords: "dailyActivity",
  actBatches: "dailyActivityBatches"
};

const LS = {
  load: (key) => JSON.parse(localStorage.getItem(key) || "[]"),
  save: (key, arr) => localStorage.setItem(key, JSON.stringify(arr))
};

/* ========= Stable keys for deletion ========= */
function recKey(r){
  const stamp = r.savedAt || "";
  const w = (r.well ?? "").toString();
  return `REC|${r.recordType}|${r.field||""}|${w}|${r.date||""}|${r.attendant||""}|${stamp}`;
}
function batchKey(b){
  const id = b.batchId || "";
  return `BAT|${id}|${b.recordType}|${b.field||""}|${b.date||""}|${b.attendant||""}|${b.count||0}`;
}

/* ========= Load everything ========= */
function loadAll(){
  const add = (arr, type) => arr.map(x => ({...x, __key: type==="rec" ? recKey(x) : batchKey(x)}));
  const records = [
    ...add(LS.load(KEYS.annualRecords),"rec"),
    ...add(LS.load(KEYS.dpRecords),"rec"),
    ...add(LS.load(KEYS.shutRecords),"rec"),
    ...add(LS.load(KEYS.obsRecords),"rec"),
    ...add(LS.load(KEYS.statusRecords),"rec"),
    ...add(LS.load(KEYS.swdRecords),"rec"),
    ...add(LS.load(KEYS.actRecords),"rec")
  ];
  const batches = [
    ...add(LS.load(KEYS.annualBatches),"bat"),
    ...add(LS.load(KEYS.dpBatches),"bat"),
    ...add(LS.load(KEYS.shutBatches),"bat"),
    ...add(LS.load(KEYS.obsBatches),"bat"),
    ...add(LS.load(KEYS.statusBatches),"bat"),
    ...add(LS.load(KEYS.swdBatches),"bat"),
    ...add(LS.load(KEYS.actBatches),"bat")
  ];
  return {records, batches};
}

let {records: allRecords, batches: allBatches} = loadAll();

/* ========= UI helpers ========= */
const unique = arr => Array.from(new Set(arr.filter(Boolean)));
function recordTitle(r){
  const dt = r.date || (r.savedAt ? r.savedAt.slice(0,10) : "");
  const id = r.well ? `${r.field || 'Field'} / ${r.well}` : (r.field || 'Field');
  return `${r.recordType || 'Record'} — ${id} — ${dt}`;
}
function batchTitle(b){
  return `${b.recordType} — ${b.field || ''} — ${b.count || (b.entries?.length||0)} items — ${b.date || ''}`;
}
function recordMeta(r){
  const parts = [];
  if (r.wellType) parts.push(r.wellType);
  if (r.attendant) parts.push(r.attendant);
  if (r.date) parts.push(r.date);
  return parts.join(" • ");
}

/* ========= CSV FLATTENING & ORDERING ========= */
// Flatten nested objects (e.g., valves, leaks) into columns.
function flattenEntry(entry){
  const out = {};
  Object.entries(entry || {}).forEach(([k,v])=>{
    if (v && typeof v === "object" && !Array.isArray(v)) {
      if (k === "valves" || k === "leaks"){
        const suffix = k === "valves" ? "Valve" : "Leak";
        Object.keys(v).sort().forEach(sub=>{
          out[`${sub} ${suffix}`] = v[sub];
        });
      } else {
        out[k] = JSON.stringify(v);
      }
    } else {
      out[k] = v;
    }
  });
  return out;
}

// Build header with this order: basics → all Valve (Master→Wing) → all Leak (Master→Wing) → rest A–Z
function headerFromFlat(flatEntries){
  const present = new Set();
  flatEntries.forEach(e => Object.keys(e).forEach(k => present.add(k)));

  const BASICS = ["recordType","date","attendant","field","well","wellType",
                  "surfacePSI","casingPSI","upstreamPSI","downstreamPSI",
                  "differentialPSI","dpH2O","fieldPressure","mcfHour",
                  "status","type","reading","activity","hours","notes"];
  const ORDER = ["Master","Tubing","Annulus","Crossover","Tail","Wing"];

  const header = [];
  BASICS.forEach(k => { if (present.has(k)) header.push(k); });
  ORDER.forEach(n => { const c = `${n} Valve`; if (present.has(c)) header.push(c); });
  ORDER.forEach(n => { const c = `${n} Leak`;  if (present.has(c)) header.push(c); });

  const already = new Set(header);
  const rest = Array.from(present).filter(k => !already.has(k)).sort((a,b)=>a.localeCompare(b));
  header.push(...rest);
  return header;
}

const esc = v => `"${String(v??"").replace(/"/g,'""')}"`;
function rowFromFlat(flatObj, header){ return header.map(k => esc(flatObj[k])).join(","); }
function csvFromEntries(entries){
  const flats = entries.map(e => flattenEntry(e));
  const header = headerFromFlat(flats);
  return [header.join(","), ...flats.map(e => rowFromFlat(e, header))].join("\n");
}
function downloadCSV(text, filename){
  const blob = new Blob(["\ufeff"+text], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename.replace(/\s+/g,"_");
  a.click(); URL.revokeObjectURL(url);
}

/* ========= Selection ========= */
const selection = new Set(); // 'record:<__key>' | 'batch:<__key>'
function updateSelCount(){ document.getElementById("selCount").textContent = `${selection.size} selected`; }
function selectAll(){
  selection.clear();
  document.querySelectorAll('input[type="checkbox"][data-sel]').forEach(cb=>{ cb.checked = true; selection.add(cb.dataset.sel); });
  updateSelCount();
}
function clearSel(){
  selection.clear();
  document.querySelectorAll('input[type="checkbox"][data-sel]').forEach(cb=>cb.checked=false);
  updateSelCount();
}

/* ========= Rendering ========= */
function initFilters(){
  const fields = unique([...allRecords.map(r=>r.field), ...allBatches.map(b=>b.field)]);
  const wells = unique(allRecords.map(r=>r.well));
  const fieldSel = document.getElementById("fieldFilter");
  const wellSel = document.getElementById("wellFilter");
  fields.forEach(f => fieldSel.appendChild(new Option(f,f)));
  wells.forEach(w => wellSel.appendChild(new Option(w,w)));
}

function btn(label, onClick, cls=""){ const b=document.createElement("button"); b.textContent=label; if(cls) b.className=cls; b.addEventListener("click", e=>{e.stopPropagation(); onClick();}); return b; }

function render(records, batches){
  const list = document.getElementById("list");
  const empty = document.getElementById("empty");
  list.innerHTML = "";
  empty.style.display = (records.length || batches.length) ? "none" : "block";

  // Batches
  batches.forEach(b=>{
    const item = document.createElement("div"); item.className="item";
    const head = document.createElement("div"); head.className="head";

    const left = document.createElement("div"); left.className="head-left";
    const cb = document.createElement("input"); cb.type="checkbox"; cb.dataset.sel=`batch:${b.__key}`;
    cb.addEventListener("click", e=>{ e.stopPropagation(); cb.checked? selection.add(cb.dataset.sel): selection.delete(cb.dataset.sel); updateSelCount(); });
    const title = document.createElement("div"); title.innerHTML = `${batchTitle(b)} <span class="batchTag">Batch</span>`;
    left.appendChild(cb); left.appendChild(title);

    const meta = document.createElement("div"); meta.className="meta"; meta.textContent=[b.attendant,b.date].filter(Boolean).join(" • ");
    head.appendChild(left); head.appendChild(meta);
    head.addEventListener("click", ()=> item.classList.toggle("open"));

    const body = document.createElement("div"); body.className="body";
    const grid = document.createElement("div"); grid.className="grid2";
    const pretty = document.createElement("pre"); pretty.textContent = JSON.stringify(b,null,2);
    grid.appendChild(pretty);

    const btns = document.createElement("div"); btns.className="btns";
    const csvBtn = btn("Download CSV (Combined)", ()=>{
      const csv = csvFromEntries(b.entries || []);
      downloadCSV(csv, `${batchTitle(b)}.csv`);
    });
    const emailBtn = btn("Email (Combined)", ()=>{
      const summary = [
        `Section: ${b.recordType}`,
        `Field: ${b.field||""}`,
        `Date: ${b.date||""}`,
        `Attendant: ${b.attendant||""}`,
        `Items: ${b.count||b.entries?.length||0}`,
        "",
        "Summary:",
        ...(b.entries||[]).slice(0,30).map(e=>`- ${e.well||e.recordType||'Item'}${e.field?` (${e.field})`:""}`)
      ].join("\n");
      window.location.href = `mailto:?subject=${encodeURIComponent('Underground Storage Field Reports — Combined')}&body=${encodeURIComponent(summary + "\n\n(Attach the CSV you downloaded.)")}`;
    });
    const delBtn = btn("Delete", ()=>{
      if (!confirm("Delete this batch? This cannot be undone.")) return;
      const keyMap = {
        "Annual Inspection":"annualInspectionBatches",
        "Daily Pressure":"dailyPressureBatches",
        "Shut-In":"shutInBatches",
        "OBS Reading":"obsReadingBatches",
        "Well Status":"wellStatusBatches",
        "SWD":"swdBatches",
        "Daily Activity":"dailyActivityBatches"
      };
      const storageKey = keyMap[b.recordType];
      if (storageKey){
        const kept = LS.load(storageKey).filter(x => batchKey(x) !== b.__key);
        LS.save(storageKey, kept);
      }
      allBatches = allBatches.filter(x => x.__key !== b.__key);
      applyFilters();
    }, "danger");

    btns.appendChild(csvBtn); btns.appendChild(emailBtn); btns.appendChild(delBtn);
    grid.appendChild(btns);
    body.appendChild(grid);
    item.appendChild(head); item.appendChild(body);
    list.appendChild(item);
  });

  // Individual records
  records.forEach(r=>{
    const item = document.createElement("div"); item.className="item";
    const head = document.createElement("div"); head.className="head";

    const left = document.createElement("div"); left.className="head-left";
    const cb = document.createElement("input"); cb.type="checkbox"; cb.dataset.sel=`record:${r.__key}`;
    cb.addEventListener("click", e=>{ e.stopPropagation(); cb.checked? selection.add(cb.dataset.sel): selection.delete(cb.dataset.sel); updateSelCount(); });
    const title = document.createElement("div"); title.textContent = recordTitle(r);
    left.appendChild(cb); left.appendChild(title);

    const meta = document.createElement("div"); meta.className="meta"; meta.textContent = recordMeta(r);
    head.appendChild(left); head.appendChild(meta);
    head.addEventListener("click", ()=> item.classList.toggle("open"));

    const body = document.createElement("div"); body.className="body";
    const grid = document.createElement("div"); grid.className="grid2";
    const pretty = document.createElement("pre"); pretty.textContent = JSON.stringify(r,null,2);
    grid.appendChild(pretty);

    const btns = document.createElement("div"); btns.className="btns";
    const csvBtn = btn("Download CSV", ()=>{
      const csv = csvFromEntries([r]);
      downloadCSV(csv, `${recordTitle(r)}.csv`);
    });
    const emailBtn = btn("Email", ()=>{
      const flat = flattenEntry(r);
      const header = headerFromFlat([flat]);
      const lines = header.map(k=>`${k}: ${typeof flat[k]==="object"? JSON.stringify(flat[k],null,2): (flat[k]??"")}`);
      window.location.href = `mailto:?subject=${encodeURIComponent('Underground Storage Field Reports')}&body=${encodeURIComponent(lines.join('\n'))}`;
    });
    const delBtn = btn("Delete", ()=>{
      if (!confirm("Delete this record? This cannot be undone.")) return;
      const keyMap = {
        "Annual Inspection":"annualInspections",
        "Daily Pressure":"dailyPressure",
        "Shut-In":"shutInLogs",
        "OBS Reading":"obsReadings",
        "Well Status":"wellStatus",
        "SWD":"swdLogs",
        "Daily Activity":"dailyActivity"
      };
      const storageKey = keyMap[r.recordType];
      if (storageKey){
        const kept = LS.load(storageKey).filter(x => recKey(x) !== r.__key);
        LS.save(storageKey, kept);
      }
      allRecords = allRecords.filter(x => x.__key !== r.__key);
      applyFilters();
    }, "danger");

    btns.appendChild(csvBtn); btns.appendChild(emailBtn); btns.appendChild(delBtn);
    grid.appendChild(btns);
    body.appendChild(grid);
    item.appendChild(head); item.appendChild(body);
    list.appendChild(item);
  });

  clearSel();
}

/* ========= Filters ========= */
function applyFilters(){
  const t = document.getElementById("typeFilter").value;
  const f = document.getElementById("fieldFilter").value;
  const w = document.getElementById("wellFilter").value;
  const d = document.getElementById("dateFilter").value;
  const a = document.getElementById("attFilter").value;

  const batches = allBatches.filter(b=>{
    if (t && b.recordType !== t) return false;
    if (f && (b.field||"") !== f) return false;
    if (d && (b.date||"").slice(0,10) !== d) return false;
    if (a && (b.attendant||"") !== a) return false;
    return true;
  });

  const records = allRecords.filter(r=>{
    if (t && r.recordType !== t) return false;
    if (f && (r.field||"") !== f) return false;
    if (w && (r.well||"") !== w) return false;
    if (d && (r.date||"").slice(0,10) !== d) return false;
    if (a && (r.attendant||"") !== a) return false;
    return true;
  });

  render(records, batches);
}
function wireFilters(){ ["typeFilter","fieldFilter","wellFilter","dateFilter","attFilter"].forEach(id=>document.getElementById(id).addEventListener("change", applyFilters)); }

/* ========= Bulk actions ========= */
function getSelected(){
  const chosen = {records:[], batches:[]};
  selection.forEach(tok=>{
    const [kind, key] = tok.split(":");
    if (kind === "record"){
      const r = allRecords.find(x => x.__key === key); if (r) chosen.records.push(r);
    } else if (kind === "batch"){
      const b = allBatches.find(x => x.__key === key); if (b) chosen.batches.push(b);
    }
  });
  return chosen;
}

function bulkCSV(){
  const {records, batches} = getSelected();
  const expanded = [...records, ...batches.flatMap(b => b.entries || [])];
  if (!expanded.length){ alert("Select some entries first."); return; }
  const csv = csvFromEntries(expanded);
  const dt = new Date().toISOString().slice(0,10);
  downloadCSV(csv, `FieldFlow_Combined_${dt}.csv`);
}
function bulkEmail(){
  const {records, batches} = getSelected();
  if (!records.length && !batches.length){ alert("Select some entries first."); return; }
  const lines = [];
  if (batches.length){
    lines.push("== Combined Batches ==");
    batches.forEach(b=>lines.push(`${b.recordType} — ${b.field||""} — ${b.count||b.entries?.length||0} items — ${b.date||""} — ${b.attendant||""}`));
    lines.push("");
  }
  if (records.length){
    lines.push("== Individual Records ==");
    records.forEach(r=>lines.push(`${r.recordType} — ${r.field||""}/${r.well||""} — ${r.date||""} — ${r.attendant||""}`));
    lines.push("");
  }
  lines.push("(Attach the combined CSV you downloaded.)");
  window.location.href = `mailto:?subject=${encodeURIComponent('Underground Storage Field Reports — Combined')}&body=${encodeURIComponent(lines.join('\n'))}`;
}
function bulkDelete(){
  const {records, batches} = getSelected();
  if (!records.length && !batches.length){ alert("Select some entries first."); return; }
  if (!confirm(`Delete ${records.length+batches.length} selected item(s)? This cannot be undone.`)) return;

  const recBuckets = {
    "Annual Inspection": KEYS.annualRecords,
    "Daily Pressure": KEYS.dpRecords,
    "Shut-In": KEYS.shutRecords,
    "OBS Reading": KEYS.obsRecords,
    "Well Status": KEYS.statusRecords,
    "SWD": KEYS.swdRecords,
    "Daily Activity": KEYS.actRecords
  };
  const batBuckets = {
    "Annual Inspection": KEYS.annualBatches,
    "Daily Pressure": KEYS.dpBatches,
    "Shut-In": KEYS.shutBatches,
    "OBS Reading": KEYS.obsBatches,
    "Well Status": KEYS.statusBatches,
    "SWD": KEYS.swdBatches,
    "Daily Activity": KEYS.actBatches
  };

  // Delete records per type
  Object.entries(recBuckets).forEach(([type, key])=>{
    const victims = records.filter(r => r.recordType === type).map(r=>r.__key);
    if (!victims.length) return;
    const kept = LS.load(key).filter(x => !victims.includes(recKey(x)));
    LS.save(key, kept);
  });

  // Delete batches per type
  Object.entries(batBuckets).forEach(([type, key])=>{
    const victims = batches.filter(b => b.recordType === type).map(b=>b.__key);
    if (!victims.length) return;
    const kept = LS.load(key).filter(x => !victims.includes(batchKey(x)));
    LS.save(key, kept);
  });

  ({records: allRecords, batches: allBatches} = loadAll());
  applyFilters();
}

/* ========= Boot ========= */
document.addEventListener("DOMContentLoaded", ()=>{
  initFilters();
  render(allRecords, allBatches);
  wireFilters();
  document.getElementById("selectAllBtn").addEventListener("click", selectAll);
  document.getElementById("clearSelBtn").addEventListener("click", clearSel);
  document.getElementById("bulkCsvBtn").addEventListener("click", bulkCSV);
  document.getElementById("bulkEmailBtn").addEventListener("click", bulkEmail);
  document.getElementById("bulkDeleteBtn").addEventListener("click", bulkDelete);
});
</script>
</body>
</html>
